// Generated by CoffeeScript 1.10.0
(function() {
  var $, Bling, extend,
    slice = [].slice,
    extend1 = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  Object.keys || (Object.keys = function(o) {
    var k, results;
    results = [];
    for (k in o) {
      results.push(k);
    }
    return results;
  });

  Object.values || (Object.values = function(o) {
    var k, results;
    results = [];
    for (k in o) {
      results.push(o[k]);
    }
    return results;
  });

  extend = function() {
    var a, aa, b, k, len1, obj, v;
    a = arguments[0], b = 2 <= arguments.length ? slice.call(arguments, 1) : [];
    for (aa = 0, len1 = b.length; aa < len1; aa++) {
      obj = b[aa];
      if (obj) {
        for (k in obj) {
          v = obj[k];
          a[k] = v;
        }
      }
    }
    return a;
  };

  Bling = (function(superClass) {
    "Bling:nomunge";
    extend1(Bling, superClass);

    function Bling() {
      var args, b, i;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      if (args.length === 1) {
        args = $.type.lookup(args[0]).array(args[0]);
      }
      b = $.inherit(Bling, args);
      if (args.length === 0 && args[0] !== void 0) {
        i = 0;
        while (args[i] !== void 0) {
          i++;
        }
        b.length = i;
      }
      if ('init' in Bling) {
        return Bling.init(b);
      }
      return b;
    }

    return Bling;

  })(Array);

  $ = Bling;

  $.global = (function() {
    return this;
  })();

  $.plugin = function(opts, constructor) {
    var _t, error, error1, fn, key, plugin, ref, ref1;
    if (!constructor) {
      constructor = opts;
      opts = {};
    }
    _t = this;
    if ("depends" in opts) {
      return _t.depends(opts.depends, function() {
        return _t.plugin({
          provides: opts.provides
        }, constructor);
      });
    }
    try {
      if (typeof (plugin = constructor != null ? constructor.call(_t, _t) : void 0) === "object") {
        extend(this, plugin.$);
        delete plugin.$;
        extend(_t.prototype, plugin);
        fn = function(key) {
          return _t[key] || (_t[key] = function() {
            var a;
            a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
            return _t.prototype[key].apply($(a[0]), a.slice(1));
          });
        };
        for (key in plugin) {
          fn(key);
        }
        if (opts.provides != null) {
          _t.provide(opts.provides);
        }
      }
    } catch (error1) {
      error = error1;
      console.error("plugin failed '" + _t.name + "':", ((ref = (ref1 = $.debugStack) != null ? ref1 : $.identity) != null ? ref : function(x) {
        return x;
      })(error.stack));
    }
    return this;
  };

  extend($, (function() {
    var commasep, complete, incomplete, not_complete, waiting;
    waiting = [];
    complete = {};
    commasep = /, */;
    not_complete = function(x) {
      return !(x in complete);
    };
    incomplete = function(n) {
      return ((typeof n) === "string" ? n.split(commasep) : n).filter(not_complete);
    };
    return {
      depends: function(needs, func) {
        if ((needs = incomplete(needs)).length === 0) {
          func();
        } else {
          waiting.push(function(need) {
            var i;
            if ((i = needs.indexOf(need)) > -1) {
              needs.splice(i, 1);
            }
            return needs.length === 0 && func;
          });
        }
        return func;
      },
      provide: function(needs, data) {
        var aa, caught, err, error1, f, i, len1, need, ref, ref1, ref2;
        caught = [];
        ref = incomplete(needs);
        for (aa = 0, len1 = ref.length; aa < len1; aa++) {
          need = ref[aa];
          complete[need] = i = -1;
          while (++i < waiting.length) {
            if ((f = waiting[i](need))) {
              waiting.splice(i, 1);
              try {
                f(data);
              } catch (error1) {
                err = error1;
                caught.push(err);
              }
              i = -1;
            }
          }
        }
        if (caught.length > 0) {
          f = (ref1 = (ref2 = $.debugStack) != null ? ref2 : $.identity) != null ? ref1 : function(x) {
            return x.stack;
          };
          caught.map(f).forEach(console.error.bind(console));
        }
        return data;
      }
    };
  })());

  $.plugin({
    depends: "core",
    provides: "async,series,parallel"
  }, function() {
    return {
      series: function(fin) {
        var done, finish_one, next, ret, todo;
        if (fin == null) {
          fin = $.identity;
        }
        ret = $();
        todo = this.length;
        if (!(todo > 0)) {
          fin.apply(ret, ret);
        } else {
          done = 0;
          finish_one = function(index) {
            return function() {
              ret[index] = arguments;
              if (++done >= todo) {
                fin.apply(ret, ret);
              } else {
                next(done);
              }
              return null;
            };
          };
          (next = (function(_this) {
            return function(i) {
              return $.immediate(function() {
                return _this[i](finish_one(i));
              });
            };
          })(this))(0);
        }
        return this;
      },
      parallel: function(fin) {
        var aa, done, finish_one, i, ref, ret, todo;
        if (fin == null) {
          fin = $.identity;
        }
        ret = $();
        todo = this.length;
        if (!(todo > 0)) {
          fin.apply(ret, ret);
        } else {
          done = 0;
          finish_one = function(index) {
            return function() {
              ret[index] = arguments;
              if (++done >= todo) {
                fin.apply(ret, ret);
              }
              return null;
            };
          };
          for (i = aa = 0, ref = todo; aa < ref; i = aa += 1) {
            this[i](finish_one(i));
          }
        }
        return this;
      }
    };
  });

  $.plugin({
    provides: "cache, Cache",
    depends: "core, sortBy, logger"
  }, function() {
    var EffCache;
    EffCache = (function() {
      var log;

      log = $.logger("[LRU]");

      function EffCache(capacity, defaultTtl) {
        var autoEvict, eff, index, noValue, order, reIndex, rePosition;
        this.capacity = capacity != null ? capacity : 1000;
        this.defaultTtl = defaultTtl != null ? defaultTtl : Infinity;
        this.capacity = Math.max(0, this.capacity);
        this.evictCount = Math.max(3, Math.floor(this.capacity * .1));
        index = Object.create(null);
        order = [];
        eff = function(o) {
          return -o.r / o.w;
        };
        autoEvict = (function(_this) {
          return function() {
            var k;
            if (!(_this.capacity > 0)) {
              return;
            }
            if (order.length >= _this.capacity) {
              while (order.length + _this.evictCount - 1 >= _this.capacity) {
                delete index[k = order.pop().k];
              }
            }
            return null;
          };
        })(this);
        reIndex = function(i, j) {
          var aa, ref, ref1, x;
          for (x = aa = ref = i, ref1 = j; ref <= ref1 ? aa <= ref1 : aa >= ref1; x = ref <= ref1 ? ++aa : --aa) {
            if ((0 <= x && x < order.length)) {
              index[order[x].k] = x;
            }
          }
          return null;
        };
        rePosition = function(i) {
          var j, obj;
          obj = order[i];
          j = $.sortedIndex(order, obj, eff);
          if (j !== i) {
            order.splice(i, 1);
            order.splice(j, 0, obj);
            reIndex(i, j);
          }
          return null;
        };
        noValue = {
          v: void 0
        };
        $.extend(this, {
          has: function(k) {
            return k in index;
          },
          del: function(k) {
            var i;
            if (k in index) {
              i = index[k];
              order.splice(i, 1);
              delete index[k];
              return reIndex(i, order.length - 1);
            }
          },
          set: (function(_this) {
            return function(k, v, ttl) {
              var d, i, item;
              if (ttl == null) {
                ttl = _this.defaultTtl;
              }
              if (!(_this.capacity > 0)) {
                return v;
              }
              if (k in index) {
                d = order[i = index[k]];
                d.v = v;
                d.w += 1;
                rePosition(i);
              } else {
                autoEvict();
                item = {
                  k: k,
                  v: v,
                  r: 0,
                  w: 1
                };
                i = $.sortedIndex(order, item, eff);
                order.splice(i, 0, item);
                reIndex(i, order.length - 1);
              }
              if (ttl < Infinity) {
                $.delay(ttl, function() {
                  return _this.del(k);
                });
              }
              return v;
            };
          })(this),
          get: function(k) {
            var i, ret;
            ret = noValue;
            if (k in index) {
              i = index[k];
              ret = order[i];
              ret.r += 1;
              rePosition(i);
            }
            return ret.v;
          },
          clear: function() {
            var k;
            for (k in index) {
              order[index[k]] = null;
            }
            index = Object.create(null);
            return order = [];
          }
        });
      }

      return EffCache;

    })();
    return {
      $: {
        Cache: $.extend(EffCache, new EffCache(10000))
      }
    };
  });

  $.plugin({
    provides: "cartesian"
  }, function() {
    return {
      $: {
        cartesian: function() {
          var helper, n, ret, sets;
          sets = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          n = sets.length;
          ret = [];
          helper = function(cur, i) {
            var aa, len1, ref, x;
            if (++i >= n) {
              return ret.push(cur);
            }
            ref = sets[i];
            for (aa = 0, len1 = ref.length; aa < len1; aa++) {
              x = ref[aa];
              helper(cur.concat(x), i);
            }
            return null;
          };
          helper([], -1);
          return $(ret);
        }
      }
    };
  });

  $.plugin({
    provides: "clone",
    depends: "type"
  }, function() {
    $.type.extend({
      unknown: {
        clone: function(s) {
          return null;
        }
      },
      string: {
        clone: function(s) {
          return s + "";
        }
      },
      number: {
        clone: function(n) {
          return n + 0.0;
        }
      },
      array: {
        clone: function(a) {
          return a.concat([]);
        }
      },
      bling: {
        clone: function(b) {
          return b.concat([]);
        }
      },
      object: {
        clone: function(o) {
          var k, ret, v;
          ret = Object.create(o.__proto__);
          for (k in o) {
            if (!hasProp.call(o, k)) continue;
            v = o[k];
            ret[k] = $.type.lookup(v).clone(v);
          }
          return ret;
        }
      }
    });
    return {
      $: {
        clone: function(o) {
          return $.type.lookup(o).clone(o);
        }
      }
    };
  });

  $.plugin({
    provides: "compat,trimLeft,split,lastIndexOf,join,preventAll,matchesSelector,isBuffer,Map"
  }, function() {
    var Map, base1, base2, base3, base4, base5, base6, signs;
    (base1 = $.global).Buffer || (base1.Buffer = {
      isBuffer: function() {
        return false;
      }
    });
    (base2 = $.global).Map || (base2.Map = Map = (function() {
      function Map(iterable) {
        var aa, data, item, len1, ref;
        data = Object.create(null);
        $.extend(this, {
          size: 0,
          keys: function() {
            return Object.keys(data);
          },
          values: function() {
            var k, results, v;
            results = [];
            for (k in data) {
              v = data[k];
              results.push(v);
            }
            return results;
          },
          entries: function() {
            var k, results, v;
            results = [];
            for (k in data) {
              v = data[k];
              results.push([k, v]);
            }
            return results;
          },
          has: function(k) {
            return k in data;
          },
          get: function(k) {
            return data[k];
          },
          set: function(k, v) {
            if (!(k in data)) {
              this.size += 1;
            }
            data[k] = v;
            return this;
          },
          "delete": function(k) {
            if (k in data) {
              this.size -= 1;
            }
            delete data[k];
            return this;
          },
          clear: function() {
            data = Object.create(null);
            this.size = 0;
            return this;
          },
          forEach: function(cb, c) {
            var k, v;
            for (k in data) {
              v = data[k];
              cb.call(c, k, v);
            }
            return this;
          }
        });
        ref = iterable != null ? iterable : [];
        for (aa = 0, len1 = ref.length; aa < len1; aa++) {
          item = ref[aa];
          this.set.apply(this, item);
        }
      }

      return Map;

    })());
    signs = [-1, 1];
    Math.sign = function(n) {
      return signs[0 + (n >= 0)];
    };
    (base3 = String.prototype).trimLeft || (base3.trimLeft = function() {
      return this.replace(/^\s+/, "");
    });
    (base4 = String.prototype).split || (base4.split = function(sep) {
      var a, i, j;
      a = [];
      i = 0;
      while ((j = this.indexOf(sep, i)) > -1) {
        a.push(this.substring(i, j));
        i = j + 1;
      }
      return a;
    });
    (base5 = String.prototype).lastIndexOf || (base5.lastIndexOf = function(s, c, i) {
      var j;
      if (i == null) {
        i = -1;
      }
      j = -1;
      while ((i = s.indexOf(c, i + 1)) > -1) {
        j = i;
      }
      return j;
    });
    (base6 = Array.prototype).join || (base6.join = function(sep) {
      var n, s;
      if (sep == null) {
        sep = '';
      }
      n = this.length;
      if (n === 0) {
        return "";
      }
      s = this[n - 1];
      while (--n > 0) {
        s = this[n - 1] + sep + s;
      }
      return s;
    });
    if (typeof Event !== "undefined" && Event !== null) {
      Event.prototype.preventAll = function() {
        this.preventDefault();
        this.stopPropagation();
        return this.cancelBubble = true;
      };
    }
    if (typeof Element !== "undefined" && Element !== null) {
      Element.prototype.matchesSelector = Element.prototype.webkitMatchesSelector || Element.prototype.mozMatchesSelector || Element.prototype.matchesSelector;
    }
    return {};
  });

  $.plugin({
    provides: 'config',
    depends: 'core'
  }, function() {
    var get, parse, set, watch;
    get = function(name, def) {
      var ref;
      switch (arguments.length) {
        case 0:
          return $.extend({}, process.env);
        default:
          return (ref = process.env[name]) != null ? ref : def;
      }
    };
    set = function(name, val) {
      switch (arguments.length) {
        case 1:
          return $.extend(process.env, arguments[0]);
        case 2:
          return process.env[name] = val;
      }
    };
    parse = function(data) {
      var ret;
      ret = {};
      $(data.toString("utf8").split("\n")).filter($.isEmpty, false).filter(/^#/, false).map(function() {
        return this.replace(/^\s+/, '').split('=');
      }).each(function(kv) {
        var ref;
        if ((ref = kv[0]) != null ? ref.length : void 0) {
          return ret[kv[0]] = kv[1].replace(/^["']/, '').replace(/['"]$/, '');
        }
      });
      return ret;
    };
    watch = function(name, func) {
      var prev;
      prev = process.env[name];
      return $.interval(1003, function() {
        var cur;
        if ((cur = process.env[name]) !== prev) {
          func(prev, cur);
          return prev = cur;
        }
      });
    };
    return {
      $: {
        config: $.extend(get, {
          get: get,
          set: set,
          parse: parse,
          watch: watch
        })
      }
    };
  });

  $.plugin({
    provides: "core,eq,each,map,filterMap,tap,replaceWith,reduce,union,intersect,distinct," + "contains,count,coalesce,swap,shuffle,select,or,zap,clean,take,skip,first,last,slice," + "push,filter,matches,weave,fold,flatten,call,apply,log,toArray,clear,indexWhere",
    depends: "string,type"
  }, function() {
    var index;
    $.defineProperty($, "now", {
      get: function() {
        return +(new Date);
      }
    });
    index = function(i, o) {
      while (i < 0) {
        i += o.length;
      }
      return Math.min(i, o.length);
    };
    return {
      $: {
        assert: function(c, m) {
          if (m == null) {
            m = "";
          }
          if (!c) {
            throw new Error("assertion failed: " + m);
          }
        },
        coalesce: function() {
          var a;
          a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          return $(a).coalesce();
        },
        keysOf: function(o, own) {
          var k;
          if (own == null) {
            own = false;
          }
          if (own) {
            return $((function() {
              var results;
              results = [];
              for (k in o) {
                if (!hasProp.call(o, k)) continue;
                results.push(k);
              }
              return results;
            })());
          } else {
            return $((function() {
              var results;
              results = [];
              for (k in o) {
                results.push(k);
              }
              return results;
            })());
          }
        },
        valuesOf: function(o, own) {
          if (own == null) {
            own = false;
          }
          return $.keysOf(o, own).map(function(k) {
            var err, error1;
            try {
              return o[k];
            } catch (error1) {
              err = error1;
              return err;
            }
          });
        }
      },
      eq: function(i) {
        return $([this[index(i, this)]]);
      },
      each: function(f) {
        var aa, len1, t;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          t = this[aa];
          f.call(t, t);
        }
        return this;
      },
      map: function(f) {
        var aa, b, i, len1, t;
        b = $();
        i = 0;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          t = this[aa];
          b[i++] = f.call(t, t);
        }
        return b;
      },
      every: function(f) {
        var aa, len1, x;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          x = this[aa];
          if (!f.call(x, x)) {
            return false;
          }
        }
        return true;
      },
      some: function(f) {
        var aa, len1, x;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          x = this[aa];
          if (f.call(x, x)) {
            return true;
          }
        }
        return false;
      },
      filterMap: function(f) {
        var aa, b, len1, t, v;
        b = $();
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          t = this[aa];
          v = f.call(t, t);
          if (v != null) {
            b.push(v);
          }
        }
        return b;
      },
      tap: function(f) {
        return f.call(this, this);
      },
      replaceWith: function(array) {
        var aa, len1, x;
        this.clear();
        for (aa = 0, len1 = array.length; aa < len1; aa++) {
          x = array[aa];
          this.push(x);
        }
        return this;
      },
      reduce: function(f, a) {
        var aa, i, n, ref, ref1, ref2, x;
        if ((typeof a) === 'function') {
          ref = [a, f], f = ref[0], a = ref[1];
        }
        i = 0;
        n = this.length;
        if (a == null) {
          a = this[i++];
        }
        for (x = aa = ref1 = i, ref2 = n; aa < ref2; x = aa += 1) {
          a = f.call(this[x], a, this[x]);
        }
        return a;
      },
      union: function(other, strict) {
        var aa, ab, len1, len2, ret, x;
        if (strict == null) {
          strict = true;
        }
        ret = $();
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          x = this[aa];
          if (!ret.contains(x, strict)) {
            ret.push(x);
          }
        }
        for (ab = 0, len2 = other.length; ab < len2; ab++) {
          x = other[ab];
          if (!ret.contains(x, strict)) {
            ret.push(x);
          }
        }
        return ret;
      },
      distinct: function(strict) {
        if (strict == null) {
          strict = true;
        }
        return this.union(this, strict);
      },
      intersect: function(other) {
        var x;
        return $((function() {
          var aa, len1, results;
          results = [];
          for (aa = 0, len1 = this.length; aa < len1; aa++) {
            x = this[aa];
            if (indexOf.call(other, x) >= 0) {
              results.push(x);
            }
          }
          return results;
        }).call(this));
      },
      contains: function(item, strict) {
        var aa, len1, t;
        if (strict == null) {
          strict = true;
        }
        if (strict) {
          return this.indexOf(item) > -1;
        } else {
          for (aa = 0, len1 = this.length; aa < len1; aa++) {
            t = this[aa];
            if (t == item) {
              return true;
            }
          }
        }
        return false;
      },
      count: function(item, strict) {
        var aa, len1, n, t;
        if (strict == null) {
          strict = true;
        }
        n = 0;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          t = this[aa];
          if ((item === void 0) || (strict && t === item) || (!strict && t == item)) {
            ++n;
          }
        }
        return n;
      },
      coalesce: function() {
        var aa, i, len1;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          i = this[aa];
          if ($.type["in"]('array', 'bling', i)) {
            i = $(i).coalesce();
          }
          if (i != null) {
            return i;
          }
        }
        return null;
      },
      swap: function(i, j) {
        var ref;
        i = index(i, this);
        j = index(j, this);
        if (i !== j) {
          ref = [this[j], this[i]], this[i] = ref[0], this[j] = ref[1];
        }
        return this;
      },
      shuffle: function() {
        var i;
        i = this.length - 1;
        while (i >= 0) {
          this.swap(--i, Math.floor(Math.random() * i));
        }
        return this;
      },
      select: (function() {
        var getter, selectMany, selectOne;
        getter = function(prop) {
          return function() {
            var v;
            if ($.is("function", v = this[prop]) && prop !== "constructor") {
              return $.bound(this, v);
            } else {
              return v;
            }
          };
        };
        selectOne = function(p) {
          var i, type;
          switch (type = $.type(p)) {
            case 'regexp':
              return selectMany.call(this, p);
            case 'string':
            case 'number':
              p = String(p);
              if (p === "*") {
                return this.flatten();
              } else if ((i = p.indexOf('.')) > -1) {
                return this.select(p.substr(0, i)).select(p.substr(i + 1));
              } else {
                return this.map(getter(p));
              }
              break;
            default:
              return $();
          }
        };
        selectMany = function() {
          var a, aa, ab, i, len1, len2, lists, match, n, p, ref;
          a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          n = this.length;
          lists = Object.create(null);
          for (aa = 0, len1 = a.length; aa < len1; aa++) {
            p = a[aa];
            if ($.is('regexp', p)) {
              ref = $.keysOf(this[0]).filter(p);
              for (ab = 0, len2 = ref.length; ab < len2; ab++) {
                match = ref[ab];
                lists[match] = this.select(match);
              }
            } else {
              lists[p] = this.select(p);
            }
          }
          i = 0;
          return this.map(function() {
            var key, obj, val;
            obj = Object.create(null);
            for (p in lists) {
              key = p.split('.').pop();
              val = lists[p][i];
              if (val !== void 0) {
                obj[key] = val;
              }
            }
            i++;
            return obj;
          });
        };
        return function() {
          switch (arguments.length) {
            case 0:
              return this;
            case 1:
              return selectOne.apply(this, arguments);
            default:
              return selectMany.apply(this, arguments);
          }
        };
      })(),
      or: function(x) {
        var aa, i, ref;
        for (i = aa = 0, ref = this.length; 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
          this[i] || (this[i] = x);
        }
        return this;
      },
      zap: function(p, v) {
        var head, i, k, tail;
        if ($.is('object', p)) {
          for (k in p) {
            v = p[k];
            this.zap(k, v);
          }
          return this;
        }
        i = p.lastIndexOf(".");
        if (i > 0) {
          head = p.substr(0, i);
          tail = p.substr(i + 1);
          this.select(head).zap(tail, v);
          return this;
        }
        switch ($.type(v)) {
          case "array":
          case "bling":
            this.each(function() {
              return this[p] = v[++i % v.length];
            });
            break;
          case "function":
            this.zap(p, this.select(p).map(v));
            break;
          default:
            this.each(function() {
              return this[p] = v;
            });
        }
        return this;
      },
      clean: function() {
        var props;
        props = 1 <= arguments.length ? slice.call(arguments, 0) : [];
        return this.each(function() {
          var aa, ab, key, len1, len2, prop, ref;
          for (aa = 0, len1 = props.length; aa < len1; aa++) {
            prop = props[aa];
            switch ($.type(prop)) {
              case 'string':
              case 'number':
                delete this[prop];
                break;
              case 'regexp':
                ref = Object.keys(this);
                for (ab = 0, len2 = ref.length; ab < len2; ab++) {
                  key = ref[ab];
                  if (prop.test(key)) {
                    delete this[key];
                  }
                }
            }
          }
          return null;
        });
      },
      take: function(n) {
        var end, i;
        if (n == null) {
          n = 1;
        }
        end = Math.min(n, this.length);
        return $((function() {
          var aa, ref, results;
          results = [];
          for (i = aa = 0, ref = end; aa < ref; i = aa += 1) {
            results.push(this[i]);
          }
          return results;
        }).call(this));
      },
      skip: function(n) {
        var i, start;
        if (n == null) {
          n = 0;
        }
        start = Math.max(0, n | 0);
        return $((function() {
          var aa, ref, ref1, results;
          results = [];
          for (i = aa = ref = start, ref1 = this.length; aa < ref1; i = aa += 1) {
            results.push(this[i]);
          }
          return results;
        }).call(this));
      },
      first: function(n) {
        if (n == null) {
          n = 1;
        }
        if (n === 1) {
          return this[0];
        } else {
          return this.take(n);
        }
      },
      last: function(n) {
        if (n == null) {
          n = 1;
        }
        if (n === 1) {
          return this[this.length - 1];
        } else {
          return this.skip(this.length - n);
        }
      },
      slice: function(start, end) {
        var i;
        if (start == null) {
          start = 0;
        }
        if (end == null) {
          end = this.length;
        }
        start = index(start, this);
        end = index(end, this);
        return $((function() {
          var aa, ref, ref1, results;
          results = [];
          for (i = aa = ref = start, ref1 = end; ref <= ref1 ? aa < ref1 : aa > ref1; i = ref <= ref1 ? ++aa : --aa) {
            results.push(this[i]);
          }
          return results;
        }).call(this));
      },
      extend: function(b) {
        var aa, i, len1;
        for (aa = 0, len1 = b.length; aa < len1; aa++) {
          i = b[aa];
          this.push(i);
        }
        return this;
      },
      push: function(b) {
        Array.prototype.push.call(this, b);
        return this;
      },
      filter: function(f, limit, positive) {
        var a, aa, g, it, len1, ref, ref1;
        if ($.is("bool", limit)) {
          ref = [limit, positive], positive = ref[0], limit = ref[1];
        }
        if ($.is("number", positive)) {
          ref1 = [positive, limit], limit = ref1[0], positive = ref1[1];
        }
        if (limit == null) {
          limit = this.length;
        }
        if (positive == null) {
          positive = true;
        }
        g = (function() {
          switch (false) {
            case !$.is("object", f):
              return function(x) {
                return $.matches(f, x);
              };
            case !$.is("string", f):
              return function(x) {
                var ref2;
                return (ref2 = x != null ? typeof x.matchesSelector === "function" ? x.matchesSelector(f) : void 0 : void 0) != null ? ref2 : false;
              };
            case !$.is("regexp", f):
              return function(x) {
                return f.test(x);
              };
            case !$.is("function", f):
              return f;
            case !$.type["in"]("bool", "number", "null", "undefined", f):
              return function(x) {
                return f === x;
              };
            default:
              throw new Error("unsupported argument to filter: " + ($.type(f)));
          }
        })();
        a = $();
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          it = this[aa];
          if ((!!g.call(it, it)) === positive) {
            if (--limit < 0) {
              break;
            }
            a.push(it);
          }
        }
        return a;
      },
      matches: function(expr) {
        switch (false) {
          case !$.is("string", expr):
            return this.select('matchesSelector').call(expr);
          case !$.is("regexp", expr):
            return this.map(function(x) {
              return expr.test(x);
            });
          default:
            throw new Error("unsupported argument to matches: " + ($.type(expr)));
        }
      },
      weave: function(b) {
        var aa, ab, c, i, ref, ref1;
        c = $();
        for (i = aa = ref = this.length - 1; aa >= 0; i = aa += -1) {
          c[(i * 2) + 1] = this[i];
        }
        for (i = ab = 0, ref1 = b.length; ab < ref1; i = ab += 1) {
          c[i * 2] = b[i];
        }
        return c;
      },
      fold: function(f) {
        var b, i, n;
        n = this.length;
        b = $((function() {
          var aa, ref, results;
          results = [];
          for (i = aa = 0, ref = n - 1; aa < ref; i = aa += 2) {
            results.push(f.call(this, this[i], this[i + 1]));
          }
          return results;
        }).call(this));
        if ((n % 2) === 1) {
          b.push(f.call(this, this[n - 1], void 0));
        }
        return b;
      },
      flatten: function() {
        var aa, ab, b, i, item, j, len1, len2;
        b = $();
        for (i = aa = 0, len1 = this.length; aa < len1; i = ++aa) {
          item = this[i];
          if ($.type["in"]('array', 'bling', 'arguments', 'nodelist', item)) {
            for (ab = 0, len2 = item.length; ab < len2; ab++) {
              j = item[ab];
              b.push(j);
            }
          } else {
            b.push(item);
          }
        }
        return b;
      },
      call: function() {
        return this.apply(null, arguments);
      },
      apply: function(context, args) {
        return this.filterMap(function() {
          if ($.is("function", this)) {
            return this.apply(context, args);
          } else {
            return null;
          }
        });
      },
      log: function(label) {
        if (label) {
          $.log(label, this.toString(), this.length + " items");
        } else {
          $.log(this.toString(), this.length + " items");
        }
        return this;
      },
      toArray: function() {
        this.__proto__ = Array.prototype;
        return this;
      },
      clear: function() {
        return this.splice(0, this.length);
      },
      indexWhere: function(f) {
        var aa, i, len1, x;
        for (i = aa = 0, len1 = this.length; aa < len1; i = ++aa) {
          x = this[i];
          if (f.call(x, x)) {
            return i;
          }
        }
        return -1;
      }
    };
  });

  $.plugin({
    provides: "css,CSS",
    depends: "type"
  }, function() {
    var compact, flatten, parse, specialOps, stripComments, trim;
    flatten = function(o, prefix, into) {
      var k, nk, v;
      if (!(prefix in into)) {
        into[prefix] = [];
      }
      for (k in o) {
        v = o[k];
        switch (typeof v) {
          case "string":
          case "number":
            nk = k.replace(/([a-z]+)([A-Z]+)/g, "$1-$2").toLowerCase();
            into[prefix].push(nk + ": " + v + ";");
            break;
          case "object":
            nk = prefix ? prefix + k : k;
            flatten(v, nk, into);
            break;
          default:
            throw new Error("unexpected type in css: " + (typeof v));
        }
      }
      return into;
    };
    trim = function(str) {
      return str.replace(/^\s+/, '').replace(/\s+$/, '');
    };
    stripComments = function(str) {
      var i, j;
      while ((i = str.indexOf("/*")) > -1) {
        if ((j = str.indexOf("*/", i)) === -1) {
          break;
        }
        str = str.substring(0, i) + str.substring(j + 2);
      }
      return str;
    };
    parse = function(str, into) {
      var aa, body, colon, key, len1, m, rest, rule, selector, value;
      if (m = str.match(/([^{]+){/)) {
        selector = trim(m[1]);
        rest = str.substring(m[0].length);
        into[selector] || (into[selector] = {});
        if (m = rest.match(/([^}]+)}/)) {
          body = m[1].split(';');
          rest = rest.substring(m[0].length);
          for (aa = 0, len1 = body.length; aa < len1; aa++) {
            rule = body[aa];
            colon = rule.indexOf(':');
            if (!(key = rule.substring(0, colon))) {
              continue;
            }
            key = trim(key);
            value = trim(rule.substring(colon + 1));
            into[selector][key] = value;
          }
        }
        if (rest.length > 0) {
          return parse(rest, into);
        }
      }
      return into;
    };
    specialOps = '>+~';
    compact = function(obj) {
      var aa, ab, cur, first, len1, len2, op, part, parts, phaseTwo, ret, rules, selector;
      ret = {};
      for (selector in obj) {
        rules = obj[selector];
        for (aa = 0, len1 = specialOps.length; aa < len1; aa++) {
          op = specialOps[aa];
          selector = selector.replace(op, " " + op + " ");
        }
        parts = selector.split(/\s+/);
        switch (parts.length) {
          case 0:
            continue;
          case 1:
            $.extend((ret[selector] || (ret[selector] = {})), rules);
            break;
          default:
            cur = ret;
            first = true;
            for (ab = 0, len2 = parts.length; ab < len2; ab++) {
              part = parts[ab];
              if (!first) {
                part = " " + part;
              }
              cur = cur[part] || (cur[part] = {});
              first = false;
            }
            $.extend(cur, rules);
        }
      }
      phaseTwo = function(cur) {
        var key, modified, subkeys, val;
        modified = false;
        for (key in cur) {
          val = cur[key];
          if ($.is('object', val)) {
            subkeys = Object.keys(val);
            switch (subkeys.length) {
              case 0:
                delete cur[key];
                break;
              default:
                if (subkeys.length === 1 && $.is('object', val[subkeys[0]])) {
                  cur[key + subkeys[0]] = val[subkeys[0]];
                  delete cur[key];
                  phaseTwo(cur);
                }
            }
            phaseTwo(val);
          }
        }
        return cur;
      };
      return phaseTwo(ret);
    };
    return {
      $: {
        CSS: {
          parse: function(str, packed) {
            var ret;
            if (packed == null) {
              packed = false;
            }
            ret = parse(stripComments(str), {});
            if (packed) {
              return compact(ret);
            } else {
              return ret;
            }
          },
          stringify: function(obj) {
            var x, y;
            return ((function() {
              var ref, results;
              ref = flatten(obj, "", {});
              results = [];
              for (x in ref) {
                y = ref[x];
                if (y.length > 0) {
                  results.push(x + " { " + (y.join(' ')) + " }");
                }
              }
              return results;
            })()).join(' ');
          }
        }
      }
    };
  });

  $.plugin({
    provides: 'date,midnight,stamp,unstamp,dateFormat,dateParse',
    depends: 'type'
  }, function() {
    var adder, d, fYY, floor, format_keys, formats, h, longDays, m, ms, pYY, pYYYY, parser_keys, parsers, ref, s, shortDays, units;
    ref = [1, 1000, 1000 * 60, 1000 * 60 * 60, 1000 * 60 * 60 * 24], ms = ref[0], s = ref[1], m = ref[2], h = ref[3], d = ref[4];
    units = {
      ms: ms,
      s: s,
      m: m,
      h: h,
      d: d,
      sec: s,
      second: s,
      seconds: s,
      min: m,
      minute: m,
      minutes: m,
      hr: h,
      hour: h,
      hours: h,
      day: d,
      days: d
    };
    shortDays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    longDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    formats = {
      yyyy: Date.prototype.getUTCFullYear,
      YY: fYY = function() {
        return String(this.getUTCFullYear()).substr(2);
      },
      yy: fYY,
      mm: function() {
        return this.getUTCMonth() + 1;
      },
      dd: Date.prototype.getUTCDate,
      dw: Date.prototype.getUTCDay,
      dW: function() {
        return shortDays[parseInt(this.getUTCDay(), 10) - 1];
      },
      DW: function() {
        return longDays[parseInt(this.getUTCDay(), 10) - 1];
      },
      HH: Date.prototype.getUTCHours,
      MM: Date.prototype.getUTCMinutes,
      SS: Date.prototype.getUTCSeconds,
      MS: Date.prototype.getUTCMilliseconds,
      _MS: function() {
        return $.padLeft(Date.prototype.getUTCMilliseconds.apply(this), 3, "0");
      }
    };
    format_keys = Object.keys(formats).sort().reverse();
    parsers = {
      YYYY: pYYYY = Date.prototype.setUTCFullYear,
      yyyy: pYYYY,
      YY: pYY = function(x) {
        return this.setUTCFullYear((x > 50 ? 1900 : 2000) + x);
      },
      yy: pYY,
      mm: function(x) {
        return this.setUTCMonth(x - 1);
      },
      dd: Date.prototype.setUTCDate,
      HH: Date.prototype.setUTCHours,
      MM: Date.prototype.setUTCMinutes,
      SS: Date.prototype.setUTCSeconds,
      _MS: function(s) {
        return this.setUTCMilliseconds(parseInt(s, 10));
      },
      MS: Date.prototype.setUTCMilliseconds
    };
    parser_keys = Object.keys(parsers).sort().reverse();
    floor = Math.floor;
    $.type.register("date", {
      is: function(o) {
        return $.isType(Date, o);
      },
      array: function(o) {
        return [o];
      },
      string: function(o, fmt, unit) {
        return $.date.format(o, fmt, unit);
      },
      number: function(o, unit) {
        return $.date.stamp(o, unit);
      }
    });
    $.type.extend('string', {
      date: function(s, fmt) {
        if (fmt == null) {
          fmt = $.date.defaultFormat;
        }
        return new Date($.date.parse(s, fmt, "ms"));
      }
    });
    $.type.extend('number', {
      date: function(n, unit) {
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return $.date.unstamp(n, unit);
      }
    });
    adder = function(key) {
      return function(stamp, delta, stamp_unit) {
        var date;
        if (stamp_unit == null) {
          stamp_unit = $.date.defaultUnit;
        }
        date = $.date.unstamp(stamp, stamp_unit);
        parsers[key].call(date, (formats[key].call(date)) + delta);
        return $.date.stamp(date, stamp_unit);
      };
    };
    return {
      $: {
        date: {
          defaultUnit: "s",
          defaultFormat: "yyyy-mm-dd HH:MM:SS",
          stamp: function(date, unit) {
            if (date == null) {
              date = new Date;
            }
            if (unit == null) {
              unit = $.date.defaultUnit;
            }
            return floor(date / units[unit]);
          },
          unstamp: function(stamp, unit) {
            if (unit == null) {
              unit = $.date.defaultUnit;
            }
            return new Date(floor(stamp * units[unit]));
          },
          convert: function(stamp, from, to) {
            if (from == null) {
              from = $.date.defaultUnit;
            }
            if (to == null) {
              to = $.date.defaultUnit;
            }
            if ($.is("date", stamp)) {
              stamp = $.date.stamp(stamp, from);
            }
            return floor(stamp * units[from] / units[to]);
          },
          midnight: function(stamp, unit) {
            if (unit == null) {
              unit = $.date.defaultUnit;
            }
            return $.date.convert($.date.convert(stamp, unit, "d"), "d", unit);
          },
          format: function(stamp, fmt, unit) {
            var aa, date, k, len1;
            if (fmt == null) {
              fmt = $.date.defaultFormat;
            }
            if (unit == null) {
              unit = $.date.defaultUnit;
            }
            if ($.is("date", stamp)) {
              stamp = $.date.stamp(stamp, unit);
            }
            date = $.date.unstamp(stamp, unit);
            for (aa = 0, len1 = format_keys.length; aa < len1; aa++) {
              k = format_keys[aa];
              fmt = fmt.replace(k, $.padLeft("" + formats[k].call(date), k.length, "0"));
            }
            return fmt;
          },
          parse: function(dateString, fmt, to) {
            var aa, date, err, error1, i, k, len1;
            if (fmt == null) {
              fmt = $.date.defaultFormat;
            }
            if (to == null) {
              to = $.date.defaultUnit;
            }
            date = new Date(0);
            i = 0;
            while (i < fmt.length) {
              for (aa = 0, len1 = parser_keys.length; aa < len1; aa++) {
                k = parser_keys[aa];
                if (fmt.indexOf(k, i) === i) {
                  try {
                    parsers[k].call(date, parseInt(dateString.slice(i, i + k.length), 10));
                  } catch (error1) {
                    err = error1;
                    throw new Error("Invalid date ('" + dateString + "') given format mask: " + fmt + " (failed at position " + i + ")");
                  }
                  i += k.length - 1;
                  break;
                }
              }
              i += 1;
            }
            return $.date.stamp(date, to);
          },
          addMilliseconds: adder("MS"),
          addSeconds: adder("SS"),
          addMinutes: adder("MM"),
          addHours: adder("HH"),
          addDays: adder("dd"),
          addMonths: adder("mm"),
          addYears: adder("yyyy"),
          range: function(from, to, interval, interval_unit, stamp_unit) {
            var add, cur, ret;
            if (interval == null) {
              interval = 1;
            }
            if (interval_unit == null) {
              interval_unit = "dd";
            }
            if (stamp_unit == null) {
              stamp_unit = $.date.defaultUnit;
            }
            add = adder(interval_unit);
            ret = [from];
            while ((cur = ret[ret.length - 1]) < to) {
              ret.push(add(cur, interval, stamp_unit));
            }
            return ret;
          }
        }
      },
      midnight: function(unit) {
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return this.map(function() {
          return $.date.midnight(this, unit);
        });
      },
      unstamp: function(unit) {
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return this.map(function() {
          return $.date.unstamp(this, unit);
        });
      },
      stamp: function(unit) {
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return this.map(function() {
          return $.date.stamp(this, unit);
        });
      },
      dateFormat: function(fmt, unit) {
        if (fmt == null) {
          fmt = $.date.defaultFormat;
        }
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return this.map(function() {
          return $.date.format(this, fmt, unit);
        });
      },
      dateParse: function(fmt, unit) {
        if (fmt == null) {
          fmt = $.date.defaultFormat;
        }
        if (unit == null) {
          unit = $.date.defaultUnit;
        }
        return this.map(function() {
          return $.date.parse(this, fmt, unit);
        });
      }
    };
  });

  $.plugin({
    provides: "debug, debugStack",
    depends: "core"
  }, function() {
    var explodeStack, protoChain;
    explodeStack = function(stack, node_modules) {
      var err, error1, files, fs, lines, lines_cache, message, nl;
      nl = /(?:\r\n|\r|\n)/;
      fs = null;
      try {
        fs = require('fs');
      } catch (error1) {
        err = error1;
        return stack;
      }
      lines = $(String(stack).split(nl)).filter(/^$/, false);
      if (!node_modules) {
        lines = lines.filter(/node_modules/, false);
      }
      message = lines.first();
      lines = lines.skip(1);
      lines_cache = Object.create(null);
      files = lines.map(function(s) {
        var before, col, error2, f, f_lines, line, ln_num, ref, spacer, tabs;
        if (s == null) {
          return null;
        }
        f = s.replace(/^\s*at\s+/g, '').replace(/.*\(([^:]+:\d+:\d+)\)$/, "$1");
        try {
          ref = f.split(/:/), f = ref[0], ln_num = ref[1], col = ref[2];
          f_lines = lines_cache[f] != null ? lines_cache[f] : lines_cache[f] = String(fs.readFileSync(f)).split(nl);
          if (f_lines == null) {
            return null;
          }
          before = "";
          if (ln_num > 1) {
            before = f_lines[ln_num - 2];
            if (before.length > 80) {
              before = "..8<.. " + before.substr(col - 25, 50) + " ..>8..";
            }
          }
          if (ln_num >= f_lines.length) {
            return null;
          }
          line = f_lines[ln_num - 1];
          if (line == null) {
            return null;
          }
          if (line.length > 80) {
            line = "..8<.." + line.substr(col - 25, 50) + "..>8..";
            col = 31;
          }
          tabs = line.replace(/[^\t]/g, '').length;
          spacer = $.repeat('\t', tabs) + $.repeat(' ', (col - 1) - tabs);
          return "  " + (ln_num - 1) + " " + before + "\n  " + ln_num + " " + line + "\n  " + ln_num + " " + spacer + "^";
        } catch (error2) {
          err = error2;
          return null;
        }
      });
      return message + "\n" + $.weave(files, lines).filter(null, false).join("\n");
    };
    protoChain = function(obj, arr) {
      if (!(obj && obj.constructor)) {
        return arr;
      }
      return protoChain(obj.constructor.__super__, arr.push(obj.constructor));
    };
    return {
      $: {
        debugStack: function(error, node_modules) {
          var stack;
          if (node_modules == null) {
            node_modules = false;
          }
          stack = (function() {
            switch (false) {
              case !$.is('error', error):
                return String(error.stack);
              case !$.is('string', error):
                return error;
              default:
                return String(error);
            }
          })();
          return explodeStack(stack, node_modules);
        },
        protoChain: function(o) {
          return protoChain(o, $());
        }
      }
    };
  });

  $.plugin({
    provides: "delay,immediate,interval",
    depends: "is,select,extend,bound"
  }, function() {
    return {
      $: {
        delay: (function() {
          var timeoutQueue;
          timeoutQueue = $.extend([], (function() {
            var next;
            next = function(a) {
              return function() {
                if (a.length) {
                  a.shift()();
                }
                return null;
              };
            };
            return {
              add: function(f, n) {
                var aa, i, ref;
                $.extend(f, {
                  order: n + $.now,
                  timeout: setTimeout(next(this), n)
                });
                for (i = aa = 0, ref = this.length; aa <= ref; i = aa += 1) {
                  if (i === this.length || this[i].order > f.order) {
                    this.splice(i, 0, f);
                    break;
                  }
                }
                return this;
              },
              cancel: function(f) {
                var i;
                if ((i = this.indexOf(f)) > -1) {
                  this.splice(i, 1);
                  clearTimeout(f.timeout);
                }
                return this;
              }
            };
          })());
          return function(n, f) {
            var b, k, v;
            switch (false) {
              case !$.is('object', n):
                b = $((function() {
                  var results;
                  results = [];
                  for (k in n) {
                    v = n[k];
                    results.push($.delay(k, v));
                  }
                  return results;
                })());
                return {
                  cancel: function() {
                    return b.select('cancel').call();
                  },
                  unref: function() {
                    return b.select('unref').call();
                  },
                  ref: function() {
                    return b.select('ref').call();
                  }
                };
              case !$.is("function", f):
                timeoutQueue.add(f, parseInt(n, 10));
                return {
                  cancel: function() {
                    return timeoutQueue.cancel(f);
                  },
                  unref: function(f) {
                    var ref;
                    return (ref = f.timeout) != null ? ref.unref() : void 0;
                  },
                  ref: function(f) {
                    var ref;
                    return (ref = f.timeout) != null ? ref.ref() : void 0;
                  }
                };
              default:
                throw new Error("Bad arguments to $.delay (expected: int,function given: " + ($.type(n)) + "," + ($.type(f)) + ")");
            }
          };
        })(),
        immediate: (function() {
          switch (false) {
            case !('setImmediate' in $.global):
              return $.global.setImmediate;
            case (typeof process !== "undefined" && process !== null ? process.nextTick : void 0) == null:
              return process.nextTick;
            default:
              return function(f) {
                return setTimeout(f, 0);
              };
          }
        })(),
        interval: function(n, f) {
          var g, paused, ret;
          paused = false;
          ret = $.delay(n, g = function() {
            if (!paused) {
              f();
            }
            return $.delay(n, g);
          });
          return $.extend(ret, {
            pause: function(p) {
              if (p == null) {
                p = true;
              }
              return paused = p;
            },
            resume: function(p) {
              if (p == null) {
                p = true;
              }
              return paused = !p;
            }
          });
        }
      },
      delay: function(n, f) {
        $.delay(n, $.bound(this, f));
        return this;
      }
    };
  });

  $.plugin({
    depends: "inherit,reduce",
    provides: "diff,stringDistance,stringDiff"
  }, function() {
    var collapse, del, diff, diff_memo, ins, lev, lev_memo, min, sub;
    lev_memo = Object.create(null);
    min = Math.min;
    lev = function(s, i, n, t, j, m, dw, iw, sw) {
      var name1, name2;
      return lev_memo[name1 = [s, i, n, t, j, m, dw, iw, sw]] != null ? lev_memo[name1] : lev_memo[name1] = lev_memo[name2 = [t, j, m, s, i, n, dw, iw, sw]] != null ? lev_memo[name2] : lev_memo[name2] = (function() {
        switch (false) {
          case !(m <= 0):
            return n;
          case !(n <= 0):
            return m;
          default:
            return min(dw + lev(s, i + 1, n - 1, t, j, m, dw, iw, sw), iw + lev(s, i, n, t, j + 1, m - 1, dw, iw, sw), (sw * (s[i] !== t[j])) + lev(s, i + 1, n - 1, t, j + 1, m - 1, dw, iw, sw));
        }
      })();
    };
    collapse = function(ops) {
      return $.inherit({
        toHTML: function() {
          return this.reduce((function(a, x) {
            return a += (function() {
              switch (x.op) {
                case 'ins':
                  return "<ins>" + x.v + "</ins>";
                case 'del':
                  return "<del>" + x.v + "</del>";
                case 'sub':
                  return "<del>" + x.v + "</del><ins>" + x.w + "</ins>";
                case 'sav':
                  return x.v;
              }
            })();
          }), "");
        }
      }, ops.reduce((function(a, x) {
        var last;
        if (x.op === 'sub' && x.v === x.w) {
          x.op = 'sav';
          delete x.w;
        }
        if (!a.length) {
          a.push(x);
        } else {
          if ((last = a.last()).op === x.op) {
            last.v += x.v;
            if (last.op === 'sub') {
              last.w += x.w;
            }
          } else {
            a.push(x);
          }
        }
        return a;
      }), $()));
    };
    diff_memo = Object.create(null);
    del = function(c) {
      return {
        op: 'del',
        v: c
      };
    };
    ins = function(c) {
      return {
        op: 'ins',
        v: c
      };
    };
    sub = function(c, d) {
      return {
        op: 'sub',
        v: c,
        w: d
      };
    };
    diff = function(s, i, n, t, j, m, dw, iw, sw) {
      var name1;
      return diff_memo[name1 = [s, i, n, t, j, m, dw, iw, sw]] != null ? diff_memo[name1] : diff_memo[name1] = collapse((function() {
        var aa, ab, args, c, costs, len1, len2, ref, ref1, results, results1;
        switch (false) {
          case !(m <= 0):
            ref = s.substr(i, n);
            results = [];
            for (aa = 0, len1 = ref.length; aa < len1; aa++) {
              c = ref[aa];
              results.push(del(c));
            }
            return results;
            break;
          case !(n <= 0):
            ref1 = t.substr(j, m);
            results1 = [];
            for (ab = 0, len2 = ref1.length; ab < len2; ab++) {
              c = ref1[ab];
              results1.push(ins(c));
            }
            return results1;
            break;
          default:
            sw *= s[i] !== t[j];
            args = {
              del: [s + 0, i + 1, n - 1, t + 0, j + 0, m + 0, 1.00, 1.50, 1.50],
              ins: [s + 0, i + 0, n + 0, t + 0, j + 1, m - 1, 1.50, 1.00, 1.50],
              sub: [s + 0, i + 1, n - 1, t + 0, j + 1, m - 1, 1.00, 1.00, 1.00]
            };
            costs = {
              del: dw + lev.apply(null, args.del),
              ins: iw + lev.apply(null, args.ins),
              sub: sw + lev.apply(null, args.sub)
            };
            switch (min(costs.del, costs.ins, costs.sub)) {
              case costs.del:
                return $(del(s[i])).concat(diff.apply(null, args.del));
              case costs.ins:
                return $(ins(t[j])).concat(diff.apply(null, args.ins));
              case costs.sub:
                return $(sub(s[i], t[j])).concat(diff.apply(null, args.sub));
            }
        }
      })());
    };
    return {
      $: {
        stringDistance: function(s, t) {
          return lev(s, 0, s.length, t, 0, t.length, 1, 1, 1);
        },
        stringDiff: function(s, t) {
          return diff(s, 0, s.length, t, 0, t.length, 1, 1, 1.5);
        }
      }
    };
  });

  if ($.global.document != null) {
    $.plugin({
      provides: "dom,HTML,html,append,appendText,appendTo,prepend,prependTo," + "before,after,wrap,unwrap,replace,attr,data,addClass,removeClass,toggleClass," + "hasClass,text,val,css,defaultCss,rect,width,height,top,left,bottom,right," + "position,scrollToCenter,child,parents,next,prev,remove,find,querySelectorAll," + "clone,toFragment",
      depends: "function,type,string"
    }, function() {
      var after, bNodelistsAreSpecial, before, escaper, getOrSetRect, parser, selectChain, toFrag, toNode;
      bNodelistsAreSpecial = false;
      $.type.register("nodelist", {
        is: function(o) {
          return (o != null) && $.isType("NodeList", o);
        },
        hash: function(o) {
          var i;
          return $((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = o.length; aa < len1; aa++) {
              i = o[aa];
              results.push($.hash(i));
            }
            return results;
          })()).sum();
        },
        array: (function() {
          var err, error1;
          try {
            document.querySelectorAll("xxx").__proto__ = {};
            return $.identity;
          } catch (error1) {
            err = error1;
            bNodelistsAreSpecial = true;
            return function(o) {
              var aa, len1, node, results;
              results = [];
              for (aa = 0, len1 = o.length; aa < len1; aa++) {
                node = o[aa];
                results.push(node);
              }
              return results;
            };
          }
        })(),
        string: function(o) {
          return "{Nodelist:[" + $(o).select('nodeName').join(",") + "]}";
        },
        node: function(o) {
          return $(o).toFragment();
        }
      });
      $.type.register("node", {
        is: function(o) {
          return (o != null ? o.nodeType : void 0) > 0;
        },
        hash: function(o) {
          return $.checksum(o.nodeName) + $.hash(o.attributes) + $.checksum(o.innerHTML);
        },
        string: function(o) {
          return o.toString();
        },
        node: $.identity
      });
      $.type.register("fragment", {
        is: function(o) {
          return (o != null ? o.nodeType : void 0) === 11;
        },
        hash: function(o) {
          var x;
          return $((function() {
            var aa, len1, ref, results;
            ref = o.childNodes;
            results = [];
            for (aa = 0, len1 = ref.length; aa < len1; aa++) {
              x = ref[aa];
              results.push($.hash(x));
            }
            return results;
          })()).sum();
        },
        string: function(o) {
          return o.toString();
        },
        node: $.identity
      });
      $.type.register("html", {
        is: function(o) {
          var s;
          return typeof o === "string" && (s = o.trimLeft())[0] === "<" && s[s.length - 1] === ">";
        },
        node: function(h) {
          var aa, childNodes, df, i, n, node, ref;
          (node = document.createElement('div')).innerHTML = h;
          if ((n = (childNodes = node.childNodes).length) === 1) {
            return node.removeChild(childNodes[0]);
          }
          df = document.createDocumentFragment();
          for (i = aa = 0, ref = n; aa < ref; i = aa += 1) {
            df.appendChild(node.removeChild(childNodes[0]));
          }
          return df;
        },
        array: function(o) {
          var h;
          return $.type.lookup(h = $.HTML.parse(o)).array(h);
        },
        string: function(o) {
          return "'" + o + "'";
        },
        repr: function(o) {
          return '"' + o + '"';
        }
      });
      $.type.extend({
        unknown: {
          node: function() {
            return null;
          }
        },
        bling: {
          node: function(o) {
            return o.toFragment();
          }
        },
        node: {
          html: function(n) {
            var d, ret;
            d = document.createElement("div");
            d.appendChild((n = n.cloneNode(true)));
            ret = d.innerHTML;
            d.removeChild(n);
            return ret;
          }
        },
        string: {
          node: function(o) {
            return $(o).toFragment();
          },
          array: (function() {
            if (bNodelistsAreSpecial) {
              return function(o) {
                var nl;
                return $.type.lookup(nl = document.querySelectorAll(o)).array(nl);
              };
            } else {
              return function(o) {
                return document.querySelectorAll(o);
              };
            }
          })()
        },
        "function": {
          node: function(o) {
            return $(o.toString()).toFragment();
          }
        }
      });
      toFrag = function(a) {
        if (!a.parentNode) {
          document.createDocumentFragment().appendChild(a);
        }
        return a;
      };
      before = function(a, b) {
        return toFrag(a).parentNode.insertBefore(b, a);
      };
      after = function(a, b) {
        return toFrag(a).parentNode.insertBefore(b, a.nextSibling);
      };
      toNode = function(x) {
        return $.type.lookup(x).node(x);
      };
      escaper = false;
      parser = false;
      $.computeCSSProperty = function(k) {
        return function() {
          return $.global.getComputedStyle(this, null).getPropertyValue(k);
        };
      };
      getOrSetRect = function(p) {
        return function(x) {
          if (x != null) {
            return this.css(p, x);
          } else {
            return this.rect().select(p);
          }
        };
      };
      selectChain = function(prop) {
        return function() {
          return this.map(function(p) {
            return $((function() {
              var results;
              results = [];
              while (p = p[prop]) {
                results.push(p);
              }
              return results;
            })());
          });
        };
      };
      return {
        $: {
          HTML: {
            parse: function(h) {
              return $.type.lookup(h).node(h);
            },
            stringify: function(n) {
              return $.type.lookup(n).html(n);
            },
            escape: function(h) {
              var ret;
              escaper || (escaper = $("<div>&nbsp;</div>").child(0));
              ret = escaper.zap('data', h).select("parentNode.innerHTML").first();
              escaper.zap('data', '');
              return ret;
            }
          }
        },
        html: function(h) {
          switch ($.type(h)) {
            case "undefined":
            case "null":
              return this.select('innerHTML');
            case "string":
            case "html":
              return this.zap('innerHTML', h);
            case "bling":
              return this.html(h.toFragment());
            case "node":
              return this.each(function() {
                var results;
                this.replaceChild(this.childNodes[0], h);
                results = [];
                while (this.childNodes.length > 1) {
                  results.push(this.removeChild(this.childNodes[1]));
                }
                return results;
              });
          }
        },
        append: function(x) {
          x = toNode(x);
          if (x == null) {
            return;
          }
          return this.each(function(n) {
            return n != null ? typeof n.appendChild === "function" ? n.appendChild(x.cloneNode(true)) : void 0 : void 0;
          });
        },
        appendText: function(text) {
          var x;
          x = document.createTextNode(text);
          if (x == null) {
            return;
          }
          return this.each(function(n) {
            return n != null ? typeof n.appendChild === "function" ? n.appendChild(x.cloneNode(true)) : void 0 : void 0;
          });
        },
        appendTo: function(x) {
          var clones, i;
          clones = this.map(function() {
            return this.cloneNode(true);
          });
          i = 0;
          $(x).each(function() {
            return this.appendChild(clones[i++]);
          });
          return clones;
        },
        prepend: function(x) {
          if (x != null) {
            x = toNode(x);
            this.take(1).each(function() {
              switch (false) {
                case !(this.childNodes.length > 0):
                  return before(this.childNodes[0], x);
                default:
                  return this.appendChild(x);
              }
            });
            this.skip(1).each(function() {
              switch (false) {
                case !this.childNodes.length:
                  return before(this.childNodes[0], x.cloneNode(true));
                default:
                  return this.appendChild(x.cloneNode(true));
              }
            });
          }
          return this;
        },
        prependTo: function(x) {
          if (x != null) {
            $(x).prepend(this);
          }
          return this;
        },
        before: function(x) {
          if (x != null) {
            x = toNode(x);
            this.take(1).each(function() {
              return before(this, x);
            });
            this.skip(1).each(function() {
              return before(this, x.cloneNode(true));
            });
          }
          return this;
        },
        after: function(x) {
          if (x != null) {
            x = toNode(x);
            this.take(1).each(function() {
              return after(this, x);
            });
            this.skip(1).each(function() {
              return after(this, x.cloneNode(true));
            });
          }
          return this;
        },
        wrap: function(parent) {
          parent = toNode(parent);
          if ($.is("fragment", parent)) {
            throw new Error("cannot call .wrap() with a fragment as the parent");
          }
          return this.each(function(child) {
            var grandpa, marker;
            if (($.is("fragment", child)) || !child.parentNode) {
              return parent.appendChild(child);
            }
            grandpa = child.parentNode;
            marker = document.createElement("dummy");
            parent.appendChild(grandpa.replaceChild(marker, child));
            return grandpa.replaceChild(parent, marker);
          });
        },
        unwrap: function() {
          return this.each(function() {
            if (this.parentNode && this.parentNode.parentNode) {
              return this.parentNode.parentNode.replaceChild(this, this.parentNode);
            } else if (this.parentNode) {
              return this.parentNode.removeChild(this);
            }
          });
        },
        replace: function(n) {
          var aa, clones, i, r, ref, ref1;
          if ($.is('regexp', n)) {
            r = arguments[1];
            return this.map(function(s) {
              return s.replace(n, r);
            });
          }
          n = toNode(n);
          clones = this.map(function() {
            return n.cloneNode(true);
          });
          for (i = aa = 0, ref = clones.length; aa < ref; i = aa += 1) {
            if ((ref1 = this[i].parentNode) != null) {
              ref1.replaceChild(clones[i], this[i]);
            }
          }
          return clones;
        },
        attr: function(a, v) {
          var k;
          if ($.is('object', a)) {
            for (k in a) {
              v = a[k];
              this.attr(k, v);
            }
          } else {
            switch (v) {
              case void 0:
                return this.select("getAttribute").call(a, v);
              case null:
                this.select("removeAttribute").call(a, v);
                break;
              default:
                this.select("setAttribute").call(a, v);
            }
          }
          return this;
        },
        data: function(k, v) {
          return this.attr("data-" + ($.dashize(k)), v);
        },
        addClass: function(x) {
          var notempty;
          notempty = function(y) {
            return y !== "";
          };
          return this.removeClass(x).each(function() {
            var c;
            c = this.className.split(" ").filter(notempty);
            c.push(x);
            return this.className = c.join(" ");
          });
        },
        removeClass: function(x) {
          var notx;
          notx = function(y) {
            return y !== x;
          };
          return this.each(function() {
            this.className = this.className.split(" ").filter(notx).join(" ");
            if (this.className.length === 0) {
              return this.removeAttribute('class');
            }
          });
        },
        toggleClass: function(x) {
          var notx;
          notx = function(y) {
            return y !== x;
          };
          return this.each(function() {
            var cls, filter;
            cls = this.className.split(" ");
            filter = $.not($.isEmpty);
            if ((cls.indexOf(x)) > -1) {
              filter = $.and(notx, filter);
            } else {
              cls.push(x);
            }
            this.className = cls.filter(filter).join(" ");
            if (this.className.length === 0) {
              return this.removeAttribute('class');
            }
          });
        },
        hasClass: function(x) {
          return this.select('className.split').call(" ").select('indexOf').call(x).map(function(x) {
            return x > -1;
          });
        },
        text: function(t) {
          if (t != null) {
            return this.zap('textContent', t);
          }
          return this.select('textContent');
        },
        val: function(v) {
          if (v != null) {
            return this.zap('value', v);
          }
          return this.select('value');
        },
        css: function(key, v) {
          var aa, i, k, n, nn, ref, setters, values;
          if ((v != null) || $.is('object', key)) {
            setters = this.select('style.setProperty');
            if ($.is("object", key)) {
              for (k in key) {
                v = key[k];
                setters.call(k, v, "");
              }
            } else if ($.is("array", v)) {
              for (i = aa = 0, ref = n = Math.max(v.length, nn = setters.length); aa < ref; i = aa += 1) {
                setters[i % nn](key, v[i % n], "");
              }
            } else if ($.is("function", v)) {
              values = this.select("style." + key).weave(this.map($.computeCSSProperty(key))).fold($.coalesce).weave(setters).fold(function(setter, value) {
                return setter(key, v.call(value, value));
              });
            } else {
              setters.call(key, v, "");
            }
            return this;
          } else {
            return this.select("style." + key).weave(this.map($.computeCSSProperty(key))).fold($.coalesce);
          }
        },
        defaultCss: function(k, v) {
          var i, sel, style;
          sel = this.selector;
          style = "";
          if ($.is("string", k)) {
            if ($.is("string", v)) {
              style += sel + " { " + k + ": " + v + " } ";
            } else {
              throw Error("defaultCss requires a value with a string key");
            }
          } else if ($.is("object", k)) {
            for (i in k + "} ") {
              style += (sel + " { ") + (i + ": " + k[i] + "; ");
            }
          }
          $("<style></style>").text(style).appendTo("head");
          return this;
        },
        rect: function() {
          return this.map(function(item) {
            switch (item) {
              case window:
                return {
                  width: window.innerWidth,
                  height: window.innerHeight,
                  top: 0,
                  left: 0,
                  right: window.innerWidth,
                  bottom: window.innerHeight
                };
              default:
                return item.getBoundingClientRect();
            }
          });
        },
        width: getOrSetRect("width"),
        height: getOrSetRect("height"),
        top: getOrSetRect("top"),
        left: getOrSetRect("left"),
        bottom: getOrSetRect("bottom"),
        right: getOrSetRect("right"),
        position: function(left, top) {
          switch (false) {
            case !(left == null):
              return this.rect();
            case !(top == null):
              return this.css("left", $.px(left));
            default:
              return this.css({
                top: $.px(top),
                left: $.px(left)
              });
          }
        },
        scrollToCenter: function() {
          document.body.scrollTop = this[0].offsetTop - ($.global.innerHeight / 2);
          return this;
        },
        child: function(n) {
          return this.select('childNodes').map(function() {
            return this[n < 0 ? n + this.length : n];
          });
        },
        parents: selectChain('parentNode'),
        prev: selectChain('previousSibling'),
        next: selectChain('nextSibling'),
        remove: function() {
          return this.each(function() {
            var ref;
            return (ref = this.parentNode) != null ? ref.removeChild(this) : void 0;
          });
        },
        find: function(css, limit) {
          if (limit == null) {
            limit = 0;
          }
          return this.filter("*").map((function() {
            switch (limit) {
              case 0:
                return function() {
                  return this.querySelectorAll(css);
                };
              case 1:
                return function() {
                  return $(this.querySelector(css));
                };
              default:
                return function() {
                  return $(this.querySelectorAll(css)).take(limit);
                };
            }
          })()).flatten();
        },
        querySelectorAll: function(expr) {
          return this.filter("*").reduce(function(a, i) {
            return a.extend(i.querySelectorAll(expr));
          }, $());
        },
        clone: function(deep, count) {
          var c;
          if (deep == null) {
            deep = true;
          }
          if (count == null) {
            count = 1;
          }
          c = function(n) {
            if ($.is("node", n)) {
              return n.cloneNode(deep);
            }
          };
          return this.map(function() {
            var _, aa, ref, results;
            switch (count) {
              case 1:
                return c(this);
              default:
                results = [];
                for (_ = aa = 0, ref = count; aa < ref; _ = aa += 1) {
                  results.push(c(this));
                }
                return results;
            }
          });
        },
        toFragment: function() {
          var df;
          if (this.length > 1) {
            df = document.createDocumentFragment();
            (this.map(toNode)).map(function(node) {
              return df.appendChild(node);
            });
            return df;
          }
          return toNode(this[0]);
        }
      };
    });
  }

  $.plugin({
    provides: "EventEmitter",
    depends: "type,hook"
  }, function() {
    return {
      $: {
        EventEmitter: $.init.append(function(obj) {
          var add, list, listeners;
          if (obj == null) {
            obj = {};
          }
          listeners = Object.create(null);
          list = function(e) {
            return listeners[e] || (listeners[e] = []);
          };
          return $.inherit({
            emit: function() {
              var a, aa, e, f, len1, ref;
              e = arguments[0], a = 2 <= arguments.length ? slice.call(arguments, 1) : [];
              ref = list(e);
              for (aa = 0, len1 = ref.length; aa < len1; aa++) {
                f = ref[aa];
                f.apply(this, a);
              }
              return this;
            },
            on: add = function(e, f) {
              var k, v;
              switch ($.type(e)) {
                case 'object':
                  for (k in e) {
                    v = e[k];
                    this.addListener(k, v);
                  }
                  break;
                case 'string':
                  list(e).push(f);
                  this.emit('newListener', e, f);
              }
              return this;
            },
            addListener: add,
            removeListener: function(e, f) {
              var i, l;
              if ((i = (l = list(e)).indexOf(f)) > -1) {
                return l.splice(i, 1);
              }
            },
            removeAllListeners: function(e) {
              return listeners[e] = [];
            },
            setMaxListeners: function() {},
            listeners: function(e) {
              return list(e).slice(0);
            }
          }, obj);
        })
      }
    };
  });

  $.plugin({
    depends: "dom,function,core",
    provides: "event,bind,unbind,trigger,delegate,undelegate,click,ready"
  }, function() {
    var EVENTSEP_RE, _b, _get, base1, binder, events, ret, triggerReady;
    EVENTSEP_RE = /,* +/;
    events = ['mousemove', 'mousedown', 'mouseup', 'mouseover', 'mouseout', 'blur', 'focus', 'load', 'unload', 'reset', 'submit', 'keyup', 'keydown', 'keypress', 'change', 'abort', 'cut', 'copy', 'paste', 'selection', 'drag', 'drop', 'orientationchange', 'touchstart', 'touchmove', 'touchend', 'touchcancel', 'gesturestart', 'gestureend', 'gesturecancel', 'hashchange'];
    binder = function(e) {
      return function(f) {
        if ($.is("function", f)) {
          return this.bind(e, f);
        } else {
          return this.trigger(e, f);
        }
      };
    };
    _get = function() {
      var keys, name1, self;
      self = arguments[0], keys = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      if (keys.length === 0) {
        return self;
      } else {
        return _get.apply(null, [(self[name1 = keys[0]] || (self[name1] = Object.create(null)))].concat(slice.call(keys.slice(1))));
      }
    };
    triggerReady = $.once(function() {
      var base1;
      $(document).trigger("ready").unbind("ready");
      if (typeof document.removeEventListener === "function") {
        document.removeEventListener("DOMContentLoaded", triggerReady, false);
      }
      return typeof (base1 = $.global).removeEventListener === "function" ? base1.removeEventListener("load", triggerReady, false) : void 0;
    });
    if (typeof document.addEventListener === "function") {
      document.addEventListener("DOMContentLoaded", triggerReady, false);
    }
    if (typeof (base1 = $.global).addEventListener === "function") {
      base1.addEventListener("load", triggerReady, false);
    }
    _b = function(funcName) {
      return function(e, f) {
        var c;
        c = (e || "").split(EVENTSEP_RE);
        return this.each(function() {
          var aa, i, len1, results;
          results = [];
          for (aa = 0, len1 = c.length; aa < len1; aa++) {
            i = c[aa];
            results.push(this[funcName](i, f, true));
          }
          return results;
        });
      };
    };
    ret = {
      bind: _b("addEventListener"),
      unbind: _b("removeEventListener"),
      trigger: function(evt, args) {
        var aa, e, evt_i, len1, ref;
        if (args == null) {
          args = {};
        }
        args = $.extend({
          bubbles: true,
          cancelable: true
        }, args);
        ref = (evt || "").split(EVENTSEP_RE);
        for (aa = 0, len1 = ref.length; aa < len1; aa++) {
          evt_i = ref[aa];
          switch (evt_i) {
            case "click":
            case "mousemove":
            case "mousedown":
            case "mouseup":
            case "mouseover":
            case "mouseout":
              e = document.createEvent("MouseEvents");
              args = $.extend({
                detail: 1,
                screenX: 0,
                screenY: 0,
                clientX: 0,
                clientY: 0,
                ctrlKey: false,
                altKey: false,
                shiftKey: false,
                metaKey: false,
                button: 0,
                relatedTarget: null
              }, args);
              e.initMouseEvent(evt_i, args.bubbles, args.cancelable, $.global, args.detail, args.screenX, args.screenY, args.clientX, args.clientY, args.ctrlKey, args.altKey, args.shiftKey, args.metaKey, args.button, args.relatedTarget);
              break;
            case "blur":
            case "focus":
            case "reset":
            case "submit":
            case "abort":
            case "change":
            case "load":
            case "unload":
              e = document.createEvent("UIEvents");
              e.initUIEvent(evt_i, args.bubbles, args.cancelable, $.global, 1);
              break;
            case "touchstart":
            case "touchmove":
            case "touchend":
            case "touchcancel":
              e = document.createEvent("TouchEvents");
              args = $.extend({
                detail: 1,
                screenX: 0,
                screenY: 0,
                clientX: 0,
                clientY: 0,
                ctrlKey: false,
                altKey: false,
                shiftKey: false,
                metaKey: false,
                touches: [],
                targetTouches: [],
                changedTouches: [],
                scale: 1.0,
                rotation: 0.0
              }, args);
              e.initTouchEvent(evt_i, args.bubbles, args.cancelable, $.global, args.detail, args.screenX, args.screenY, args.clientX, args.clientY, args.ctrlKey, args.altKey, args.shiftKey, args.metaKey, args.touches, args.targetTouches, args.changedTouches, args.scale, args.rotation);
              break;
            case "gesturestart":
            case "gestureend":
            case "gesturecancel":
              e = document.createEvent("GestureEvents");
              args = $.extend({
                detail: 1,
                screenX: 0,
                screenY: 0,
                clientX: 0,
                clientY: 0,
                ctrlKey: false,
                altKey: false,
                shiftKey: false,
                metaKey: false,
                target: null,
                scale: 1.0,
                rotation: 0.0
              }, args);
              e.initGestureEvent(evt_i, args.bubbles, args.cancelable, $.global, args.detail, args.screenX, args.screenY, args.clientX, args.clientY, args.ctrlKey, args.altKey, args.shiftKey, args.metaKey, args.target, args.scale, args.rotation);
              break;
            case "keydown":
            case "keypress":
            case "keyup":
              e = document.createEvent("KeyboardEvents");
              args = $.extend({
                view: null,
                ctrlKey: false,
                altKey: false,
                shiftKey: false,
                metaKey: false,
                keyCode: 0,
                charCode: 0
              }, args);
              e.initKeyboardEvent(evt_i, args.bubbles, args.cancelable, $.global, args.ctrlKey, args.altKey, args.shiftKey, args.metaKey, args.keyCode, args.charCode);
              break;
            default:
              e = document.createEvent("Events");
              e.initEvent(evt_i, args.bubbles, args.cancelable);
              e = $.extend(e, args);
          }
          if (!e) {
            continue;
          }
          this.each(function() {
            var err, error1;
            try {
              return this.dispatchEvent(e);
            } catch (error1) {
              err = error1;
              return $.log("dispatchEvent error:", err);
            }
          });
        }
        return this;
      },
      delegate: function(selector, e, f) {
        var h;
        h = (function(_this) {
          return function(evt) {
            var t;
            t = $(evt.target);
            return _this.find(selector).intersect(t.parents().first().union(t)).each(function() {
              return f.call(evt.target = this, evt);
            });
          };
        })(this);
        return this.bind(e, h).each(function() {
          return _get(this, '__alive__', selector, e)[f] = h;
        });
      },
      undelegate: function(selector, e, f) {
        var context;
        context = this;
        return context.each(function() {
          var c;
          c = _get(this, '__alive__', selector, e);
          if (c && c[f]) {
            context.unbind(e, c[f]);
            return delete c[f];
          }
        });
      },
      click: function(f) {
        var ref;
        if (f == null) {
          f = {};
        }
        if ((ref = this.css("cursor")) === "auto" || ref === "") {
          this.css("cursor", "pointer");
        }
        if ($.is("function", f)) {
          this.bind('click', f);
        } else {
          this.trigger('click', f);
        }
        return this;
      },
      ready: function(f) {
        if (triggerReady.exhausted) {
          return f.call(this);
        }
        return this.bind("ready", f);
      }
    };
    events.forEach(function(x) {
      return ret[x] = binder(x);
    });
    return ret;
  });

  $.plugin({
    provides: "function,identity,compose,once,cycle,bound,partial",
    depends: "extend,is,defineProperty,map"
  }, function() {
    return {
      $: {
        identity: function(o) {
          return o;
        },
        not: function(f) {
          return function() {
            return !f.apply(this, arguments);
          };
        },
        compose: function(f, g) {
          return function(x) {
            var y;
            return f.call(y, (y = g.call(x, x)));
          };
        },
        and: function(f, g) {
          return function(x) {
            return g.call(this, x) && f.call(this, x);
          };
        },
        once: function(f, n) {
          if (n == null) {
            n = 1;
          }
          return $.defineProperty((function() {
            if (n-- > 0) {
              return f.apply(this, arguments);
            }
          }), "exhausted", {
            get: function() {
              return n <= 0;
            }
          });
        },
        cycle: function() {
          var f, i;
          f = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          i = -1;
          return function() {
            return f[i = ++i % f.length].apply(this, arguments);
          };
        },
        bound: function(t, f, args) {
          var r;
          if (args == null) {
            args = [];
          }
          if (f == null) {
            return $.identity;
          }
          if ($.is("function", f.bind)) {
            args.splice(0, 0, t);
            r = f.bind.apply(f, args);
          } else {
            r = function() {
              var a;
              a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
              return f.apply(t, (args.length ? args : a));
            };
          }
          return $.extend(r, {
            toString: function() {
              return "bound-method of " + t + "." + f.name;
            }
          });
        },
        partial: function() {
          var a, f;
          f = arguments[0], a = 2 <= arguments.length ? slice.call(arguments, 1) : [];
          return function() {
            var b;
            b = 1 <= arguments.length ? slice.call(arguments, 0) : [];
            return f.apply(null, slice.call(a).concat(slice.call(b)));
          };
        }
      },
      partial: function() {
        var a;
        a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
        return this.map(function(f) {
          return $.partial.apply($, [f].concat(slice.call(a)));
        });
      }
    };
  });

  $.plugin({
    provides: "hash",
    depends: "type"
  }, function() {
    var array_hash, maxHash;
    maxHash = 0xFFFFFFFF;
    array_hash = function(d) {
      return function(o) {
        var x;
        return d + $((function() {
          var aa, len1, results;
          results = [];
          for (aa = 0, len1 = o.length; aa < len1; aa++) {
            x = o[aa];
            results.push($.hash(x));
          }
          return results;
        })()).reduce((function(a, x) {
          return ((a * a) + (x | 0)) % maxHash;
        }), 1);
      };
    };
    $.type.extend({
      unknown: {
        hash: function(o) {
          return $.checksum($.toString(o));
        }
      },
      object: {
        hash: function(o) {
          var k, v;
          return 1970931729 + $((function() {
            var results;
            results = [];
            for (k in o) {
              v = o[k];
              results.push($.hash(k) + $.hash(v));
            }
            return results;
          })()).sum();
        }
      },
      array: {
        hash: array_hash(1816922041)
      },
      "arguments": {
        hash: array_hash(298517431)
      },
      bling: {
        hash: array_hash(92078573)
      },
      bool: {
        hash: function(o) {
          return parseInt(o ? 1 : void 0);
        }
      },
      regexp: {
        hash: function(o) {
          return 148243084 + $.checksum($.toString(o));
        }
      }
    });
    return {
      $: {
        hash: function(x) {
          return $.type.lookup(x).hash(x);
        }
      },
      hash: function() {
        return $.hash(this);
      }
    };
  });

  $.plugin(function() {
    return {
      $: {
        histogram: function(data, bucket_width, output_width) {
          var aa, ab, buckets, end, i, len, len1, m, max, mean, min, n, pct, pct_sum, ref, ret, sum, total, x;
          if (bucket_width == null) {
            bucket_width = 1;
          }
          if (output_width == null) {
            output_width = 60;
          }
          buckets = $();
          len = 0;
          min = Infinity;
          mean = 0;
          max = 0;
          total = 0;
          for (aa = 0, len1 = data.length; aa < len1; aa++) {
            x = data[aa];
            min = Math.min(x, min);
            max = Math.max(x, max);
            total += x;
            i = Math.floor(x / bucket_width);
            if (i in buckets) {
              buckets[i] += 1;
            } else {
              buckets[i] = 1;
            }
            len = Math.max(len, i + 1);
          }
          buckets.length = len;
          mean = total / data.length;
          m = buckets.max();
          buckets = buckets.or(0).scale(1 / m).scale(output_width);
          sum = buckets.sum();
          ret = "";
          pct_sum = 0;
          for (n = ab = 0, ref = len; ab < ref; n = ab += 1) {
            end = (n + 1) * bucket_width;
            pct = buckets[n] * 100 / sum;
            pct_sum += pct;
            ret += $.padLeft(pct_sum.toFixed(2) + "%", 7) + $.padRight(" < " + (end.toFixed(2)), 10) + ": " + $.repeat("#", buckets[n]) + "\n";
          }
          return ret + ("N: " + data.length + " Min: " + (min.toFixed(2)) + " Max: " + (max.toFixed(2)) + " Mean: " + (mean.toFixed(2)));
        }
      },
      histogram: function() {
        return $.histogram(this);
      }
    };
  });

  $.plugin({
    provides: "hook",
    depends: "type"
  }, function() {
    var hook;
    hook = function() {
      var chain;
      chain = [];
      return $.extend((function(args) {
        var aa, func, len1;
        for (aa = 0, len1 = chain.length; aa < len1; aa++) {
          func = chain[aa];
          args = func.call(this, args);
        }
        return args;
      }), {
        prepend: function(o) {
          chain.unshift(o);
          return o;
        },
        append: function(o) {
          chain.push(o);
          return o;
        }
      });
    };
    $.init = hook();
    return {
      $: {
        hook: hook
      }
    };
  });

  $.plugin({
    depends: "dom",
    provides: "http"
  }, function() {
    var formencode;
    formencode = function(obj) {
      var i, o;
      if ($.is('object', obj)) {
        o = JSON.parse(JSON.stringify(obj));
        return ((function() {
          var results;
          results = [];
          for (i in o) {
            results.push(i + "=" + (escape(o[i])));
          }
          return results;
        })()).join("&");
      } else {
        return obj;
      }
    };
    $.type.register("http", {
      is: function(o) {
        return $.isType('XMLHttpRequest', o);
      },
      array: function(o) {
        return [o];
      }
    });
    return {
      $: {
        http: function(url, opts) {
          var k, ref, v, xhr;
          if (opts == null) {
            opts = {};
          }
          xhr = new XMLHttpRequest();
          if ($.is("function", opts)) {
            opts = {
              success: $.bound(xhr, opts)
            };
          }
          opts = $.extend({
            method: "GET",
            data: null,
            state: $.identity,
            success: $.identity,
            error: $.identity,
            async: true,
            asBlob: false,
            timeout: 0,
            followRedirects: false,
            withCredentials: false,
            headers: {}
          }, opts);
          opts.state = $.bound(xhr, opts.state);
          opts.success = $.bound(xhr, opts.success);
          opts.error = $.bound(xhr, opts.error);
          if (opts.data && opts.method === "GET") {
            url += "?" + formencode(opts.data);
          } else if (opts.data && opts.method === "POST") {
            opts.data = formencode(opts.data);
          }
          xhr.open(opts.method, url, opts.async);
          xhr = $.extend(xhr, {
            asBlob: opts.asBlob,
            timeout: opts.timeout,
            followRedirects: opts.followRedirects,
            withCredentials: opts.withCredentials,
            onreadystatechange: function() {
              if (typeof opts.state === "function") {
                opts.state();
              }
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  return opts.success(xhr.responseText);
                } else {
                  return opts.error(xhr.status, xhr.statusText);
                }
              }
            }
          });
          ref = opts.headers;
          for (k in ref) {
            v = ref[k];
            xhr.setRequestHeader(k, v);
          }
          xhr.send(opts.data);
          return $(xhr);
        },
        post: function(url, opts) {
          if (opts == null) {
            opts = {};
          }
          if ($.is("function", opts)) {
            opts = {
              success: opts
            };
          }
          opts.method = "POST";
          return $.http(url, opts);
        },
        get: function(url, opts) {
          if (opts == null) {
            opts = {};
          }
          if ($.is("function", opts)) {
            opts = {
              success: opts
            };
          }
          opts.method = "GET";
          return $.http(url, opts);
        }
      }
    };
  });

  $.depends('hook', function() {
    return $.init.append(function(obj) {
      var keyMakers, map;
      map = new Map();
      keyMakers = [];
      return $.inherit({
        index: function(keyFunc) {
          var _map, aa, key, len1, x;
          if (keyMakers.indexOf(keyFunc) === -1) {
            keyMakers.push(keyFunc);
            map.set(keyFunc.toString(), new Map());
          }
          for (aa = 0, len1 = this.length; aa < len1; aa++) {
            x = this[aa];
            key = keyFunc(x);
            _map = map.get(keyFunc.toString());
            if (!_map.has(key)) {
              _map.set(key, $());
            }
            _map.get(key).push(x);
          }
          return this;
        },
        query: function(criteria) {
          var _map, aa, key, keyMaker, len1;
          for (aa = 0, len1 = keyMakers.length; aa < len1; aa++) {
            keyMaker = keyMakers[aa];
            _map = map.get(keyMaker.toString());
            if (_map.has(key = keyMaker(criteria))) {
              return _map.get(key);
            }
          }
          return $();
        },
        queryOne: function(criteria) {
          return this.query(criteria)[0];
        }
      }, obj);
    });
  });

  $.plugin({
    provides: "toHTML",
    depends: "type,synth,once"
  }, function() {
    var dumpScript, dumpStyles, table, tableRow;
    dumpStyles = $.once(function() {
      try {
        return $("head").append($.synth("style#dump").text("table.dump                { border: 1px solid black; }\ntable.dump tr.h           { background-color: blue; color: white; cursor: pointer; }\ntable.dump tr.h th        { padding: 0px 4px; }\ntable.dump tr.h.array     { background-color: purple; }\ntable.dump tr.h.bling     { background-color: gold; }\ntable.dump td             { padding: 2px; }\ntable.dump td.k           { background-color: lightblue; }\ntable.dump td.v.string    { background-color: #cfc; }\ntable.dump td.v.number    { background-color: #ffc; }\ntable.dump td.v.bool      { background-color: #fcf; }"));
      } catch (undefined) {}
    });
    dumpScript = $.once(function() {
      try {
        return $("head").append($.synth("script#dump").text("$(document.body).delegate('table.dump tr.h', 'click', function() {\n	$(this.parentNode).find(\"tr.kv\").toggle()\n})"));
      } catch (undefined) {}
    });
    table = function(t, rows) {
      var aa, len1, row, tab;
      tab = $.synth("table.dump tr.h." + t + " th[colspan=2] '" + t + "'");
      if (t === "array" || t === "bling" || t === "nodelist") {
        tab.find("th").appendText(" [" + rows.length + "]");
      }
      for (aa = 0, len1 = rows.length; aa < len1; aa++) {
        row = rows[aa];
        tab.append(row);
      }
      return tab[0];
    };
    tableRow = function(k, v, open) {
      var _t, row, td;
      row = $.synth("tr.kv td.k[align=right][valign=top] '" + k + "' + td.v");
      td = row.find("td.v");
      switch (_t = $.type(v = $.toHTML(v, open))) {
        case "string":
        case "number":
        case "bool":
        case "html":
        case "null":
        case "undefined":
          td.appendText(String(v));
          break;
        default:
          td.append(v);
      }
      td.addClass(_t);
      if (!open) {
        row.toggle();
      }
      return row;
    };
    return {
      $: {
        toHTML: function(obj, open) {
          var k, s, t, v;
          if (open == null) {
            open = true;
          }
          dumpStyles();
          dumpScript();
          switch (t = $.type(obj)) {
            case "string":
            case "number":
            case "bool":
            case "null":
            case "undefined":
            case "html":
              return obj;
            case "bling":
            case "array":
            case "nodelist":
              return table(t, (function() {
                var aa, len1, results;
                results = [];
                for (k = aa = 0, len1 = obj.length; aa < len1; k = ++aa) {
                  v = obj[k];
                  results.push(tableRow(k, v, open));
                }
                return results;
              })());
            case "object":
            case "array":
              return table(t, (function() {
                var results;
                results = [];
                for (k in obj) {
                  v = obj[k];
                  results.push(tableRow(k, v, open));
                }
                return results;
              })());
            case "node":
              s = $.HTML.stringify(obj);
              return s.substr(0, s.indexOf('>') + 1) + '...';
            default:
              return String(obj);
          }
        }
      }
    };
  });

  $.plugin({
    provides: 'keyName,keyNames',
    depends: "math"
  }, function() {
    var a, aa, ab, code, keyCode, keyName, len1, len2, name, ref, ref1;
    keyCode = {
      "Backspace": 8,
      "BS": 8,
      "Tab": 9,
      '\t': 9,
      "Enter": 13,
      '\n': 12,
      "Shift": 16,
      "Ctrl": 17,
      "Alt": 18,
      "Pause": 19,
      "Break": 19,
      "Caps": 20,
      "Caps Lock": 20,
      "Esc": 27,
      "Escape": 27,
      "Space": 32,
      " ": 32,
      "PgUp": 33,
      "Page Up": 33,
      "PgDn": 34,
      "End": 35,
      "Home": 36,
      "Left": 37,
      "Up": 38,
      "Right": 39,
      "Down": 40,
      "Insert": 45,
      "Del": 46,
      "Delete": 46,
      "Times": 106,
      "*": 106,
      "Plus": 107,
      "+": 107,
      "Minus": 109,
      "-": 109,
      "Div": 111,
      "Divide": 111,
      "/": 111,
      "Semi-Colon": 186,
      ";": 187,
      "Equal": 187,
      "=": 187,
      "Comma": 188,
      ",": 188,
      "Dash": 189,
      "-": 189,
      "Dot": 190,
      "Period": 190,
      ".": 190,
      "Forward Slash": 191,
      "/": 191,
      "Back Slash": 220,
      "\\": 220,
      "Single Quote": 222,
      "'": 222
    };
    ref = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    for (aa = 0, len1 = ref.length; aa < len1; aa++) {
      a = ref[aa];
      keyCode[a] = keyCode[a.toLowerCase()] = a.charCodeAt(0);
    }
    ref1 = $.range(1, 13);
    for (ab = 0, len2 = ref1.length; ab < len2; ab++) {
      a = ref1[ab];
      keyCode["F" + a] = keyCode["f" + a] = 111 + a;
    }
    keyName = {};
    for (name in keyCode) {
      code = keyCode[name];
      keyName[code] || (keyName[code] = name);
    }
    return {
      $: {
        keyCode: function(name) {
          var ref2;
          return (ref2 = keyCode[name]) != null ? ref2 : name;
        },
        keyName: function(code) {
          var ref2;
          return (ref2 = keyName[code]) != null ? ref2 : code;
        }
      }
    };
  });

  $.plugin({
    depends: "dom,promise",
    provides: "lazy"
  }, function() {
    var lazy_load;
    lazy_load = function(elementName, props) {
      var elem, ret;
      ret = $.Promise();
      document.head.appendChild(elem = $.extend(document.createElement(elementName), props, {
        onload: function() {
          return ret.resolve(elem);
        },
        onerror: function() {
          return ret.reject.apply(ret, arguments);
        }
      }));
      return ret;
    };
    return {
      $: {
        script: function(src) {
          return lazy_load("script", {
            src: src
          });
        },
        style: function(src) {
          return lazy_load("link", {
            href: src,
            rel: "stylesheet"
          });
        }
      }
    };
  });

  $.plugin({
    provides: "log, logger",
    depends: "bound"
  }, function() {
    var log;
    log = function() {
      var a, p;
      a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      if (a.length) {
        if (p = typeof log.pre === "function" ? log.pre() : void 0) {
          a.unshift(p);
        }
        log.out.apply(log, a);
        return a[a.length - 1];
      }
    };
    log.out = console.log.bind(console);
    log.pre = null;
    log.enableTimestamps = function(level) {
      if (level == null) {
        level = 2;
      }
      return log.pre = [
        null, function() {
          return String(+new Date());
        }, function() {
          return $.date.format(+new Date(), "yyyy-mm-dd HH:MM:SS._MS", "ms");
        }
      ][level];
    };
    log.disableTimestamps = function() {
      return log.enableTimestamps(0);
    };
    return {
      $: {
        log: log,
        logger: function(prefix) {
          return function() {
            var a;
            a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
            a.unshift(prefix);
            return log.apply(null, a);
          };
        }
      }
    };
  });

  $.plugin({
    provides: "matches",
    depends: "function,core,string"
  }, function() {
    var ArrayMatch, Contains, ContainsValue, IsEqual, ObjMatch, RegExpMatch, aa, ab, behaviors, f, len1, len2, list, matches, obj_type, pt, specialPatterns, v;
    IsEqual = function(p, o, t) {
      return o === p;
    };
    Contains = function(p, a, t) {
      var aa, len1, v;
      for (aa = 0, len1 = a.length; aa < len1; aa++) {
        v = a[aa];
        if (matches(p, v, t)) {
          return true;
        }
      }
      return false;
    };
    ContainsValue = function(p, o, t) {
      var k, v;
      for (k in o) {
        v = o[k];
        if (matches(p, v, t)) {
          return true;
        }
      }
      return false;
    };
    ObjMatch = function(p, o, t) {
      var k, v;
      for (k in p) {
        v = p[k];
        if (!(matches(v, o[k]))) {
          return false;
        }
      }
      return true;
    };
    ArrayMatch = function(p, o, t) {
      var aa, i, len1, v;
      for (i = aa = 0, len1 = p.length; aa < len1; i = ++aa) {
        v = p[i];
        if (!(matches(v, o[i]))) {
          return false;
        }
      }
      return true;
    };
    RegExpMatch = function(p, s, t) {
      return p.test(String(s));
    };
    behaviors = {
      "function": [['array', 'bling', Contains], ['object', ContainsValue]],
      regexp: [['string', 'number', RegExpMatch], ['array', 'bling', Contains], ['object', ContainsValue]],
      object: [['array', 'bling', Contains], ['object', ObjMatch]],
      array: [['array', 'bling', ArrayMatch]],
      number: [['number', IsEqual], ['array', 'bling', Contains]],
      string: [['string', IsEqual], ['array', 'bling', Contains]]
    };
    for (pt in behaviors) {
      v = behaviors[pt];
      matches = {};
      for (aa = 0, len1 = v.length; aa < len1; aa++) {
        list = v[aa];
        f = list.pop();
        for (ab = 0, len2 = list.length; ab < len2; ab++) {
          obj_type = list[ab];
          matches[obj_type] = f;
        }
      }
      $.type.extend(pt, {
        matches: matches
      });
    }
    specialPatterns = {
      $any: function() {
        return true;
      },
      $type: function(p, o, t) {
        return $.is(p.$type, o);
      },
      $class: function(p, o, t) {
        return $.isType(p.$class, o);
      },
      $lt: function(p, o, t) {
        return o < p.$lt;
      },
      $gt: function(p, o, t) {
        return o > p.$gt;
      },
      $lte: function(p, o, t) {
        return o <= p.$lte;
      },
      $gte: function(p, o, t) {
        return o >= p.$gte;
      }
    };
    matches = function(pattern, obj, pt) {
      var k, ref, ref1, ref2, type;
      if (pt == null) {
        pt = $.type.lookup(pattern);
      }
      if (pt.name === 'object') {
        for (k in specialPatterns) {
          f = specialPatterns[k];
          if (k in pattern) {
            return f(pattern, obj, pt);
          }
        }
      }
      ref = pt.matches;
      for (type in ref) {
        f = ref[type];
        if (type === 'else') {
          continue;
        }
        if ($.is(type, obj)) {
          return f(pattern, obj, pt);
        }
      }
      return (ref1 = (ref2 = pt.matches) != null ? typeof ref2["else"] === "function" ? ref2["else"](pattern, obj, pt) : void 0 : void 0) != null ? ref1 : IsEqual(pattern, obj, pt);
    };
    matches.Any = {
      $any: true
    };
    matches.Type = function(type) {
      return {
        $type: type
      };
    };
    matches.Class = function(klass) {
      return {
        $class: klass
      };
    };
    return {
      $: {
        matches: matches
      }
    };
  });

  $.plugin({
    provides: "math",
    depends: "core"
  }, function() {
    var _By, add, mean, sub;
    $.type.extend({
      bool: {
        number: function(o) {
          if (o) {
            return 1;
          } else {
            return 0;
          }
        }
      },
      number: {
        bool: function(o) {
          return !!o;
        }
      }
    });
    _By = function(cmp) {
      return function(field) {
        var valueOf, x;
        valueOf = (function() {
          switch (false) {
            case !$.is("string", field):
              return function(o) {
                return o[field];
              };
            case !$.is("function", field):
              return field;
            default:
              throw new Error(".maxBy first argument should be a string or function");
          }
        })();
        x = this.first();
        this.skip(1).each(function(n) {
          if (cmp(valueOf(n), valueOf(x))) {
            return x = n;
          }
        });
        return x;
      };
    };
    return {
      $: {
        range: function(start, end, step) {
          var i;
          if (step == null) {
            step = 1;
          }
          if (end == null) {
            end = start;
            start = 0;
          }
          if (end < start && step > 0) {
            step *= -1;
          }
          return $((function() {
            var aa, ref, results;
            results = [];
            for (i = aa = 0, ref = Math.ceil((end - start) / step); 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
              results.push(start + (i * step));
            }
            return results;
          })());
        },
        zeros: function(n, z) {
          var i;
          if (z == null) {
            z = 0;
          }
          return $((function() {
            var aa, ref, results;
            results = [];
            for (i = aa = 0, ref = n; 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
              results.push(z);
            }
            return results;
          })());
        },
        ones: function(n) {
          var i;
          return $((function() {
            var aa, ref, results;
            results = [];
            for (i = aa = 0, ref = n; 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
              results.push(1);
            }
            return results;
          })());
        },
        deg2rad: function(n) {
          return n * Math.PI / 180;
        },
        rad2deg: function(n) {
          return n * 180 / Math.PI;
        }
      },
      floats: function() {
        return this.map(parseFloat);
      },
      ints: function() {
        return this.map(function() {
          return parseInt(this, 10);
        });
      },
      px: function(delta) {
        return this.ints().map(function() {
          return $.px(this, delta);
        });
      },
      min: function() {
        return this.filter(isFinite).reduce(Math.min);
      },
      max: function() {
        return this.filter(isFinite).reduce(Math.max);
      },
      maxBy: _By(function(a, b) {
        return a > b;
      }),
      minBy: _By(function(a, b) {
        return a < b;
      }),
      mean: mean = function() {
        if (!this.length) {
          return 0;
        } else {
          return this.sum() / this.length;
        }
      },
      avg: mean,
      sum: function() {
        var aa, len1, n, x;
        n = 0;
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          x = this[aa];
          if ((x != null) && isFinite(x)) {
            n += x;
          }
        }
        return n;
      },
      product: function() {
        return this.filter(isFinite).reduce(function(a) {
          return a * this;
        });
      },
      squares: function() {
        return this.pow(2);
      },
      pow: function(n) {
        return this.map(function() {
          return Math.pow(this, n);
        });
      },
      magnitude: function() {
        return Math.sqrt(this.floats().squares().sum());
      },
      scale: function(r) {
        return this.map(function() {
          return r * this;
        });
      },
      add: add = function(d) {
        var i;
        switch ($.type(d)) {
          case "number":
            return this.map(function() {
              return d + this;
            });
          case "bling":
          case "array":
            return $((function() {
              var aa, ref, results;
              results = [];
              for (i = aa = 0, ref = Math.min(this.length, d.length); 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
                results.push(this[i] + d[i]);
              }
              return results;
            }).call(this));
        }
      },
      plus: add,
      sub: sub = function(d) {
        var i;
        switch ($.type(d)) {
          case "number":
            return this.map(function() {
              return this - d;
            });
          case "bling":
          case "array":
            return $((function() {
              var aa, ref, results;
              results = [];
              for (i = aa = 0, ref = Math.min(this.length, d.length); 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
                results.push(this[i] - d[i]);
              }
              return results;
            }).call(this));
        }
      },
      minus: sub,
      dot: function(b) {
        var i;
        return $.sum((function() {
          var aa, ref, results;
          results = [];
          for (i = aa = 0, ref = Math.min(this.length, b.length); 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
            results.push(this[i] * b[i]);
          }
          return results;
        }).call(this));
      },
      angle: function(b) {
        return Math.acos(this.dot(b) / (this.magnitude() * b.magnitude()));
      },
      cross: function(b) {
        return $(this[1] * b[2] - this[2] * b[1], this[2] * b[0] - this[0] * b[2], this[0] * b[1] - this[1] * b[0]);
      },
      normalize: function() {
        return this.scale(1 / this.magnitude());
      },
      deg2rad: function() {
        return this.filter(isFinite).map(function() {
          return this * Math.PI / 180;
        });
      },
      rad2deg: function() {
        return this.filter(isFinite).map(function() {
          return this * 180 / Math.PI;
        });
      }
    };
  });

  $.plugin({
    depends: "function,hash",
    provides: 'memoize'
  }, function() {
    var plainCache;
    plainCache = function() {
      var data;
      data = {};
      return {
        has: function(k) {
          return k in data;
        },
        get: function(k) {
          return data[k];
        },
        set: function(k, v) {
          return data[k] = v;
        }
      };
    };
    return {
      $: {
        memoize: function(opts) {
          if ($.is("function", opts)) {
            opts = {
              f: opts
            };
          }
          if (!$.is('object', opts)) {
            throw new Error("Argument Error: memoize requires either a function or object as first argument");
          }
          opts.cache || (opts.cache = plainCache());
          opts.hash || (opts.hash = $.hash);
          return function() {
            var key;
            key = opts.hash(arguments);
            if (opts.cache.has(key)) {
              return opts.cache.get(key);
            } else {
              return opts.cache.set(key, opts.f.apply(this, arguments));
            }
          };
        }
      }
    };
  });

  $.plugin({
    provides: 'middleware',
    depends: 'type'
  }, function() {
    return {
      $: {
        middleware: function(s) {
          var e;
          if (s == null) {
            s = [];
          }
          e = $();
          return {
            "catch": function(f) {
              e.push(f);
              return this;
            },
            use: function(f) {
              s.push(f);
              return this;
            },
            unuse: function(f) {
              var i;
              while ((i = s.indexOf(f)) > -1) {
                s.splice(i, 1);
              }
              return this;
            },
            invoke: function() {
              var a, i, next;
              a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
              i = -1;
              (next = ((function(_this) {
                return function() {
                  var _e, error1;
                  try {
                    return s[++i].apply(s, slice.call(a).concat([next]));
                  } catch (error1) {
                    _e = error1;
                    return e.call(_e);
                  }
                };
              })(this)))();
              return this;
            }
          };
        }
      }
    };
  });

  $.plugin({
    depends: "core,function",
    provides: "promise"
  }, function() {
    var NoValue, Progress, Promise;
    NoValue = (function() {
      function NoValue() {}

      return NoValue;

    })();
    Promise = function(obj) {
      var consume_all, consume_one, end, err, getState, isFailed, isFinished, result, ret, waiting;
      if (obj == null) {
        obj = {};
      }
      waiting = [];
      err = result = NoValue;
      consume_all = function(e, v) {
        var w;
        while (w = waiting.shift()) {
          consume_one(w, e, v);
        }
        return null;
      };
      consume_one = function(cb, e, v) {
        var __e, __stack, _e, _stack, error1, error2, ref;
        if ((ref = cb.timeout) != null) {
          ref.cancel();
        }
        try {
          cb(e, v);
        } catch (error1) {
          _e = error1;
          _stack = $.debugStack(_e);
          $.log("Promise(" + ret.promiseId + ") first-chance exception:", _stack);
          try {
            cb(_e, null);
          } catch (error2) {
            __e = error2;
            __stack = $.debugStack(__e);
            $.log("Promise(" + ret.promiseId + ") last-chance exception:", __stack);
          }
        }
        return null;
      };
      end = (function(_this) {
        return function(error, value) {
          if ((err === result && result === NoValue)) {
            if (error !== NoValue) {
              err = error;
              if (!(error != null ? error.stack : void 0)) {
                err = new Error(error);
              }
            } else if (value !== NoValue) {
              result = value;
            }
            switch (true) {
              case value === _this:
                return end(new TypeError("cant resolve a promise with itself"));
              case $.is('promise', value):
                value.wait(end);
                break;
              case error !== NoValue:
                consume_all(err, null);
                break;
              case value !== NoValue:
                consume_all(null, result);
            }
          }
          return _this;
        };
      })(this);
      ret = $.inherit({
        promiseId: $.random.string(6),
        wait: function(timeout, cb) {
          var ref;
          if ($.is("function", timeout)) {
            ref = [timeout, Infinity], cb = ref[0], timeout = ref[1];
          }
          if (err !== NoValue) {
            $.immediate(function() {
              return consume_one(cb, err, null);
            });
          } else if (result !== NoValue) {
            $.immediate(function() {
              return consume_one(cb, null, result);
            });
          } else {
            waiting.push(cb);
            if (isFinite(parseFloat(timeout))) {
              cb.timeout = $.delay(timeout, function() {
                var i;
                if ((i = waiting.indexOf(cb)) > -1) {
                  waiting.splice(i, 1);
                  return consume_one(cb, err = new Error('timeout'), void 0);
                }
              });
            }
          }
          return this;
        },
        then: function(f, e) {
          return this.wait(function(err, x) {
            if (err) {
              return typeof e === "function" ? e(err) : void 0;
            } else {
              return f(x);
            }
          });
        },
        finish: function(value) {
          end(NoValue, value);
          return this;
        },
        resolve: function(value) {
          end(NoValue, value);
          return this;
        },
        fail: function(error) {
          end(error, NoValue);
          return this;
        },
        reject: function(error) {
          end(error, NoValue);
          return this;
        },
        reset: function() {
          err = result = NoValue;
          return this;
        },
        handler: function(err, data) {
          if (err) {
            return ret.reject(err);
          } else {
            return ret.resolve(data);
          }
        },
        inspect: function() {
          return "{Promise[" + this.promiseId + "] " + (getState()) + "}";
        },
        toString: function() {
          return "{Promise[" + this.promiseId + "] " + (getState()) + "}";
        }
      }, $.EventEmitter(obj));
      getState = function() {
        switch (false) {
          case result === NoValue:
            return "resolved";
          case err === NoValue:
            return "rejected";
          default:
            return "pending";
        }
      };
      isFinished = function() {
        return result !== NoValue;
      };
      $.defineProperty(ret, 'finished', {
        get: isFinished
      });
      $.defineProperty(ret, 'resolved', {
        get: isFinished
      });
      isFailed = function() {
        return err !== NoValue;
      };
      $.defineProperty(ret, 'failed', {
        get: isFailed
      });
      $.defineProperty(ret, 'rejected', {
        get: isFailed
      });
      return ret;
    };
    Promise.compose = Promise.parallel = function() {
      var p, promises;
      promises = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      promises = $(promises).flatten();
      p = $.Progress(1 + promises.length);
      $(promises).select('wait').call(function(err) {
        if (err) {
          return p.reject(err);
        } else {
          return p.resolve(1);
        }
      });
      return p.resolve(1);
    };
    Promise.collect = function(promises) {
      var aa, fn, i, len1, p, promise, q, ret;
      ret = [];
      p = $.Promise();
      if (promises == null) {
        return p.resolve(ret);
      }
      q = $.Progress(1 + promises.length);
      fn = function(i) {
        return promise.wait(function(err, result) {
          if (err) {
            return q.reject(err);
          } else {
            return q.resolve(1, ret[i] = result);
          }
        });
      };
      for (i = aa = 0, len1 = promises.length; aa < len1; i = ++aa) {
        promise = promises[i];
        fn(i);
      }
      q.then((function() {
        return p.resolve(ret);
      }), p.reject);
      q.resolve(1);
      return p;
    };
    Promise.wrapCall = function() {
      var args, f, p;
      f = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      p = $.Promise();
      f.apply(null, slice.call(args).concat([function(e, r) {
        if (e) {
          return p.reject(e);
        } else {
          return p.resolve(r);
        }
      }]));
      return p;
    };
    Progress = function(max) {
      var cur, ret;
      if (max == null) {
        max = 1.0;
      }
      cur = 0.0;
      return ret = $.inherit({
        progress: function() {
          var args, item, ref, ref1;
          args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          if (!args.length) {
            return cur;
          }
          cur = (ref = args[0]) != null ? ref : cur;
          if (args.length > 1) {
            max = (ref1 = args[1]) != null ? ref1 : max;
          }
          item = args.length > 2 ? args[2] : cur;
          if (cur >= max) {
            ret.__proto__.__proto__.resolve(item);
          }
          ret.emit('progress', cur, max, item);
          return this;
        },
        resolve: function(delta, item) {
          if (item == null) {
            item = delta;
          }
          if (!isFinite(delta)) {
            delta = 1;
          }
          return ret.progress(cur + delta, max, item);
        },
        finish: function(delta, item) {
          return ret.resolve(delta, item);
        },
        include: function(promise) {
          if ($.is('promise', promise)) {
            ret.progress(cur, max + 1);
            promise.wait(function(err, data) {
              if (err) {
                return ret.reject(err);
              } else {
                return ret.resolve(data);
              }
            });
          }
          return this;
        },
        inspect: function() {
          return "{Progress[" + ret.promiseId + "] " + cur + "/" + max + "}";
        }
      }, Promise());
    };
    Promise.xhr = function(xhr) {
      var p;
      p = $.Promise();
      xhr.onreadystatechange = function() {
        if (this.readyState === this.DONE) {
          if (this.status === 200) {
            return p.resolve(xhr.responseText);
          } else {
            return p.resolve(this.status + " " + this.statusText);
          }
        }
      };
      return p;
    };
    Promise.series = function() {
      var p, run, series;
      series = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      series = $(series).flatten();
      run = function(i) {
        return function() {
          if (i >= series.length) {
            return;
          }
          return series[i] = series[i]().wait(function(err, result) {
            p.resolve(series[i] = [err, result]);
            return $.immediate(run(i + 1));
          });
        };
      };
      p = $.Progress(series.length);
      $.immediate(run(0));
      return p;
    };
    $.depends('dom', function() {
      return Promise.image = function(src) {
        var image, p;
        p = $.Promise();
        $.extend(image = new Image(), {
          onerror: function(e) {
            return p.reject(e);
          },
          onload: function() {
            return p.resolve(image);
          },
          src: src
        });
        return p;
      };
    });
    $.depends('type', function() {
      return $.type.register('promise', {
        is: function(o) {
          return (o != null) && ('object' === typeof o) && 'then' in o && 'function' === typeof o.then && o.then.length === 2;
        }
      });
    });
    return {
      $: {
        Promise: Promise,
        Progress: Progress
      }
    };
  });

  $.plugin({
    provides: 'prompt,confirm',
    depends: 'synth,keyName'
  }, function() {
    var _confirm, _prompt, _prompt_css;
    _prompt_css = function() {
      if (!$("head .prompt").length) {
        return $("head").append("<style class='prompt'>" + $.CSS.stringify({
          ".prompt": {
            position: "absolute",
            top: 0,
            left: 0,
            width: "100%",
            height: "100%",
            zIndex: "999999",
            background: "rgba(0,0,0,.4)",
            fontSize: "12px",
            " input": {
              padding: "2px",
              margin: "0px 0px 4px -4px",
              width: "100%"
            },
            " button": {
              fontSize: "13px",
              ".done": {
                fontSize: "14px"
              }
            },
            " > center": {
              width: "200px",
              height: "44px",
              margin: "20px auto",
              padding: "16px",
              background: "#ffc",
              borderRadius: "5px"
            }
          }
        }) + "</style>");
      }
    };
    _prompt = function(label, type, cb) {
      var cancelButton, dialog, done, doneButton, input;
      _prompt_css();
      dialog = $.synth("div.prompt center\n	input[type=" + type + "][placeholder=" + label + "] + br +\n	button.cancel 'Cancel' +\n	button.done 'Done'").appendTo("body").first();
      input = dialog.querySelector("input");
      input.onkeydown = function(evt) {
        switch ($.keyName(evt.keyCode)) {
          case "Enter":
            return done(input.value);
          case "Esc":
            return done(null);
        }
      };
      doneButton = dialog.querySelector("button.done");
      cancelButton = dialog.querySelector("button.cancel");
      done = function(value) {
        delete doneButton.onclick;
        delete cancelButton.onclick;
        dialog.parentNode.removeChild(dialog);
        return cb(value);
      };
      doneButton.onclick = function() {
        return done(input.value);
      };
      cancelButton.onclick = function() {
        return done(null);
      };
      return null;
    };
    _confirm = function() {
      var aa, args, buttons, cb, center, dialog, label, len1, value;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      cb = args.pop();
      label = args.shift();
      if (args.length > 0) {
        buttons = args;
      } else {
        buttons = {
          Yes: true,
          No: false
        };
      }
      _prompt_css();
      dialog = $.synth("div.prompt center\n	span '" + label + "' + br").appendTo("body");
      center = dialog.find('center');
      switch ($.type(buttons)) {
        case 'array':
        case 'bling':
          for (aa = 0, len1 = buttons.length; aa < len1; aa++) {
            label = buttons[aa];
            $.synth("button[value=" + label + "] '" + label + "'").appendTo(center);
          }
          break;
        case 'object':
          for (label in buttons) {
            value = buttons[label];
            $.synth("button[value=" + value + "] '" + label + "'").appendTo(center);
          }
      }
      dialog.find("button").bind("click", function(evt) {
        dialog.remove();
        return cb(evt.target.getAttribute('value'));
      });
      return null;
    };
    return {
      $: {
        prompt: _prompt,
        confirm: _confirm
      }
    };
  });

  $.plugin({
    depends: "core",
    provides: "pubsub"
  }, function() {
    var Hub;
    Hub = (function() {
      function Hub() {
        this.listeners = {};
      }

      Hub.prototype.publish = function() {
        var aa, args, base1, caught, channel, err, error1, len1, listener, ref;
        channel = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
        caught = null;
        ref = (base1 = this.listeners)[channel] || (base1[channel] = []);
        for (aa = 0, len1 = ref.length; aa < len1; aa++) {
          listener = ref[aa];
          if (this.filter.apply(this, [listener].concat(slice.call(args)))) {
            try {
              listener.apply(null, args);
            } catch (error1) {
              err = error1;
              if (caught == null) {
                caught = err;
              }
            }
          }
        }
        if (caught) {
          throw caught;
        }
        switch (args.length) {
          case 0:
            return null;
          case 1:
            return args[0];
          default:
            return args;
        }
      };

      Hub.prototype.filter = function(listener, message) {
        if ('patternObject' in listener) {
          return $.matches(listener.patternObject, message);
        }
        return true;
      };

      Hub.prototype.publisher = function(channel, func) {
        var t;
        t = this;
        return function() {
          return t.publish(channel, func.apply(this, arguments));
        };
      };

      Hub.prototype.subscribe = function() {
        var args, base1, channel, func;
        channel = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
        func = args.pop();
        if (args.length > 0) {
          func.patternObject = args.pop();
        }
        ((base1 = this.listeners)[channel] || (base1[channel] = [])).push(func);
        return func;
      };

      Hub.prototype.unsubscribe = function(channel, func) {
        var a, base1, i;
        if (func == null) {
          this.listeners[channel] = [];
        } else {
          a = ((base1 = this.listeners)[channel] || (base1[channel] = []));
          if ((i = a.indexOf(func)) > -1) {
            a.splice(i, 1);
          }
        }
        return func;
      };

      return Hub;

    })();
    return {
      $: $.extend(new Hub(), {
        Hub: Hub
      })
    };
  });

  $.plugin({
    provides: 'random',
    depends: 'type'
  }, function() {
    var abs, die, element, englishAlphabet, floor, integer, log, max_int, next, random, real, s, string, uuidAlphabet;
    englishAlphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    uuidAlphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    floor = Math.floor, abs = Math.abs, log = Math.log;
    max_int = 0xFFFFFFFF;
    s = new Uint32Array(2);
    next = function() {
      var result, s0, s1;
      s0 = s[0];
      s1 = s[1];
      result = (s0 + s1) % max_int;
      s1 ^= s0;
      s[0] = (s0 << 27) | (s0 >>> 5) ^ s1 ^ (s1 << 7);
      s[1] = (s1 << 18) | (s1 >>> 14);
      return result;
    };
    random = function() {
      return next() / max_int;
    };
    $.defineProperty(random, 'seed', {
      set: function(n) {
        s[0] = n;
        s[1] = 1;
        next();
        next();
        next();
        return n;
      }
    });
    random.seed = $.now;
    return {
      $: {
        random: $.extend(random, {
          real: real = function(min, max) {
            var ref, ref1;
            if (min == null) {
              ref = [0, 1.0], min = ref[0], max = ref[1];
            }
            if (max == null) {
              ref1 = [0, min], min = ref1[0], max = ref1[1];
            }
            return (random() * (max - min)) + min;
          },
          integer: integer = function(min, max) {
            return floor(real(min, max));
          },
          string: string = function(len, prefix, alphabet) {
            if (prefix == null) {
              prefix = "";
            }
            if (alphabet == null) {
              alphabet = englishAlphabet;
            }
            while (prefix.length < len) {
              prefix += element(alphabet);
            }
            return prefix;
          },
          coin: function(balance) {
            if (balance == null) {
              balance = .5;
            }
            return random() <= balance;
          },
          element: element = function(arr, weights) {
            var aa, i, item, len1, r, sorted, sum, w;
            if (weights != null) {
              w = $(weights);
              w = w.scale(1.0 / w.sum());
              i = 0;
              sorted = $(arr).map(function(x) {
                return {
                  v: x,
                  w: w[i++]
                };
              }).sortBy(function(x) {
                return -x.w;
              });
              r = random();
              sum = 0;
              for (aa = 0, len1 = sorted.length; aa < len1; aa++) {
                item = sorted[aa];
                if ((sum += item.w) >= r) {
                  return item.v;
                }
              }
            }
            return arr[integer(0, arr.length)];
          },
          gaussian: function(mean, ssig) {
            var q, u, v, x, y;
            if (mean == null) {
              mean = 0.5;
            }
            if (ssig == null) {
              ssig = 0.12;
            }
            while (true) {
              u = random();
              v = 1.7156 * (random() - 0.5);
              x = u - 0.449871;
              y = abs(v) + 0.386595;
              q = (x * x) + y * (0.19600 * y - 0.25472 * x);
              if (!(q > 0.27597 && (q > 0.27846 || (v * v) > (-4 * log(u) * u * u)))) {
                break;
              }
            }
            return mean + ssig * v / u;
          },
          die: die = function(faces) {
            return integer(1, faces + 1);
          },
          dice: function(n, faces) {
            return $((function() {
              var aa, ref, results;
              results = [];
              for (aa = 0, ref = n; aa < ref; aa += 1) {
                results.push(die(faces));
              }
              return results;
            })());
          },
          uuid: function() {
            return $(8, 4, 4, 4, 12).map(function() {
              return string(this, '', uuidAlphabet);
            }).join('-');
          }
        })
      }
    };
  });

  $.plugin({
    provides: "render",
    depends: "promise, type, logger"
  }, function() {
    var aka, array_finalize, array_reduce, consume_forever, finalize, log, object_handlers, reduce, register, render;
    log = $.logger("[render]");
    consume_forever = function(promise, opts, p) {
      if (p == null) {
        p = $.Promise();
      }
      if (!$.is("promise", promise)) {
        return $.Promise().resolve(reduce(promise, opts));
      }
      promise.wait(function(err, result) {
        var r;
        if (err) {
          return p.reject(err);
        }
        r = reduce(result, opts);
        if ($.is('promise', r)) {
          return consume_forever(r, opts, p);
        } else {
          return p.resolve(r);
        }
      });
      return p;
    };
    render = function(o, opts) {
      var r;
      if (opts == null) {
        opts = {};
      }
      return consume_forever(r = reduce([o], opts), opts);
    };
    object_handlers = {
      text: function(o, opts) {
        var ref;
        return reduce(o[(ref = opts.lang) != null ? ref : "EN"], opts);
      }
    };
    render.register = register = function(t, f) {
      return object_handlers[t] = f;
    };
    render.reduce = reduce = function(o, opts) {
      var t;
      return (t = $.type.lookup(o)).reduce(o, t, opts);
    };
    $.type.extend({
      unknown: {
        reduce: function(o, t, opts) {
          return "[ cant reduce type: " + t + " ]";
        }
      },
      string: {
        reduce: $.identity
      },
      html: {
        reduce: $.identity
      },
      "null": {
        reduce: function(o, t, opts) {
          return t;
        }
      },
      undefined: {
        reduce: function(o, t, opts) {
          return t;
        }
      },
      number: {
        reduce: function(o, t, opts) {
          return String(o);
        }
      },
      "function": {
        reduce: function(o, t, opts) {
          switch (f.length) {
            case 0:
            case 1:
              return reduce(f(opts));
            default:
              return $.Promise.wrap(f, opts);
          }
        }
      },
      object: {
        reduce: function(o, t, opts) {
          var ref;
          if ((t = (ref = o.t) != null ? ref : o.type) in object_handlers) {
            return object_handlers[t].call(o, o, opts);
          } else {
            return "[ no handler for object type: '" + t + "' " + (JSON.stringify(o).substr(0, 20)) + "... ]";
          }
        }
      },
      promise: {
        reduce: function(o, t, opts) {
          var finish_q, q;
          q = $.Promise();
          o.wait(finish_q = function(err, result) {
            var r;
            if (err) {
              return q.reject(err);
            }
            if ($.is('promise', r = reduce(result, opts))) {
              return r.wait(finish_q);
            } else {
              return q.resolve(r);
            }
          });
          return q;
        }
      },
      array: {
        reduce: array_reduce = function(o, t, opts) {
          var aa, fn, has_promises, i, len1, m, n, p, q, x;
          p = $.Progress(m = 1);
          q = $.Promise();
          n = [];
          p.wait(function(err) {
            if (err) {
              return q.reject(err);
            } else {
              return q.resolve(finalize(n, opts));
            }
          });
          has_promises = false;
          fn = function(x, i) {
            var finish_p, y;
            n[i] = y = reduce(x, opts);
            if ($.is('promise', y)) {
              has_promises = true;
              p.progress(null, ++m);
              return y.wait(finish_p = function(err, result) {
                var rp;
                if (err) {
                  return p.reject(err);
                }
                rp = reduce(result, opts);
                if ($.is('promise', rp)) {
                  return rp.wait(finish_p);
                } else {
                  return p.resolve(n[i] = rp);
                }
              });
            }
          };
          for (i = aa = 0, len1 = o.length; aa < len1; i = ++aa) {
            x = o[i];
            fn(x, i);
          }
          p.resolve(1);
          if (has_promises) {
            return q;
          } else {
            return finalize(n);
          }
        }
      },
      bling: {
        reduce: array_reduce
      }
    });
    finalize = function(o, opts) {
      var t;
      return (t = $.type.lookup(o)).finalize(o, t, opts);
    };
    $.type.extend({
      unknown: {
        finalize: function(o, t, opts) {
          return "[ cant finalize type: " + t + " ]";
        }
      },
      string: {
        finalize: $.identity
      },
      html: {
        finalize: $.identity
      },
      number: {
        finalize: function(o, t, opts) {
          return String(o);
        }
      },
      array: {
        finalize: array_finalize = function(o, t, opts) {
          var x;
          return ((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = o.length; aa < len1; aa++) {
              x = o[aa];
              results.push(finalize(x, opts));
            }
            return results;
          })()).join('');
        }
      },
      bling: {
        finalize: array_finalize
      },
      "null": {
        finalize: function() {
          return "null";
        }
      },
      undefined: {
        finalize: function() {
          return "undefined";
        }
      }
    });
    aka = function(name) {
      return object_handlers[name];
    };
    register('link', function(o, opts) {
      var k;
      return [
        "<a", (function() {
          var aa, len1, ref, results;
          ref = ["href", "name", "target"];
          results = [];
          for (aa = 0, len1 = ref.length; aa < len1; aa++) {
            k = ref[aa];
            if (k in o) {
              results.push([" " + k + "='", o[k], "'"]);
            }
          }
          return results;
        })(), ">", reduce(o.content, opts), "</a>"
      ];
    });
    register('a', aka('link'));
    register('let', function(o, opts) {
      var ret, save;
      save = opts[o.name];
      opts[o.name] = o.value;
      ret = reduce(o.content, opts);
      if (save === void 0) {
        delete opts[o.name];
      } else {
        opts[o.name] = save;
      }
      return ret;
    });
    register('set', aka('let'));
    register('get', function(o, opts) {
      return reduce(opts[o.name], opts);
    });
    return {
      $: {
        render: render
      }
    };
  });

  $.plugin({
    provides: "sortBy,sortedIndex,sortedInsert"
  }, function() {
    return {
      $: {
        sortedIndex: function(array, item, sorter, lo, hi) {
          var cmp, mid;
          if (lo == null) {
            lo = 0;
          }
          if (hi == null) {
            hi = array.length;
          }
          cmp = (function() {
            switch (true) {
              case $.is("string", sorter):
                return function(a, b) {
                  return a[sorter] < b[sorter];
                };
              case $.is("function", sorter):
                return function(a, b) {
                  return sorter(a) < sorter(b);
                };
              default:
                return function(a, b) {
                  return a < b;
                };
            }
          })();
          while (lo < hi) {
            mid = (hi + lo) >>> 1;
            if (cmp(array[mid], item)) {
              lo = mid + 1;
            } else {
              hi = mid;
            }
          }
          return lo;
        }
      },
      sortBy: function(sorter) {
        var a, aa, item, len1, n;
        a = $();
        for (aa = 0, len1 = this.length; aa < len1; aa++) {
          item = this[aa];
          n = $.sortedIndex(a, item, sorter);
          a.splice(n, 0, item);
        }
        return a;
      },
      sortedInsert: function(item, sorter) {
        this.splice($.sortedIndex(this, item, sorter), 0, item);
        return this;
      },
      groupBy: function(sorter) {
        var aa, c, groups, k, len1, name1, x;
        groups = {};
        switch ($.type(sorter)) {
          case 'array':
          case 'bling':
            for (aa = 0, len1 = this.length; aa < len1; aa++) {
              x = this[aa];
              c = ((function() {
                var ab, len2, results;
                results = [];
                for (ab = 0, len2 = key.length; ab < len2; ab++) {
                  k = key[ab];
                  results.push(x[k]);
                }
                return results;
              })()).join(",");
              (groups[c] || (groups[c] = $())).push(x);
            }
            break;
          case (function() {
              var ab, len2, results;
              results = [];
              for (ab = 0, len2 = this.length; ab < len2; ab++) {
                x = this[ab];
                results.push('string');
              }
              return results;
            }).call(this):
            (groups[name1 = x[key]] || (groups[name1] = $())).push(x);
        }
        return $.valuesOf(groups);
      }
    };
  });

  $.plugin({
    provides: "StateMachine",
    depends: "type, logger"
  }, function() {
    var StateMachine, _callAll, log;
    _callAll = function(f, c, arg) {
      while ((typeof f) === "function") {
        f = f.call(c, arg);
      }
      if ($.is('number', f)) {
        return c.state = f;
      }
    };
    log = $.logger("[StateMachine]");
    return {
      $: {
        StateMachine: StateMachine = (function() {
          var go;

          function StateMachine(table1) {
            var state;
            this.table = table1;
            state = null;
            $.defineProperty(this, "state", {
              set: function(m) {
                if (m !== state && m in this.table) {
                  _callAll(this.table[state = m].enter, this);
                } else if (m === null) {
                  state = null;
                }
                return state;
              },
              get: function() {
                return state;
              }
            });
          }

          StateMachine.prototype.goto = go = function(m, reset) {
            if (reset == null) {
              reset = false;
            }
            return function() {
              if (reset) {
                this.state = null;
              }
              return this.state = m;
            };
          };

          StateMachine.goto = go;

          StateMachine.prototype.tick = function(c) {
            var ref, row;
            row = this.table[this.state];
            if (row == null) {
              return null;
            }
            return _callAll((ref = row[c]) != null ? ref : row.def, this, c);
          };

          StateMachine.prototype.run = function(inputs) {
            var aa, c, len1;
            this.state = 0;
            for (aa = 0, len1 = inputs.length; aa < len1; aa++) {
              c = inputs[aa];
              this.tick(c);
            }
            _callAll(this.table[this.state].eof, this);
            return this;
          };

          return StateMachine;

        })()
      }
    };
  });

  $.plugin({
    provides: "string",
    depends: "type"
  }, function() {
    var escape_single_quotes, safer, slugize, strip_ansi_codes;
    safer = function(f) {
      return function() {
        var a, err, error1;
        a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
        try {
          return f.apply(null, a);
        } catch (error1) {
          err = error1;
          return "[toString Error: " + err.message + "]";
        }
      };
    };
    escape_single_quotes = function(s) {
      return s.replace(/([^\\]{1})'/g, "$1\\'");
    };
    strip_ansi_codes = function(s) {
      return String(s).replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
    };
    $.type.extend({
      unknown: {
        string: safer(function(o) {
          var ref;
          return (ref = typeof o.toString === "function" ? o.toString() : void 0) != null ? ref : String(o);
        }),
        repr: safer(function(o) {
          return $.type.lookup(o).string(o);
        }),
        number: safer(function(o) {
          return parseFloat(String(o));
        })
      },
      "null": {
        string: function() {
          return "null";
        }
      },
      undefined: {
        string: function() {
          return "undefined";
        }
      },
      buffer: {
        string: safer(function(o) {
          return String(o);
        }),
        repr: safer(function(o) {
          return "Buffer(" + (JSON.stringify(o.toJSON())) + ")";
        })
      },
      string: {
        number: safer(parseFloat),
        repr: function(s) {
          return "'" + (escape_single_quotes(s)) + "'";
        }
      },
      array: {
        string: safer(function(a) {
          return "[" + (a.map($.toString).join(', ')) + "]";
        }),
        repr: safer(function(a) {
          return "[" + (a.map($.toRepr).join(', ')) + "]";
        })
      },
      "arguments": {
        string: safer(function(a) {
          var x;
          return "[" + (((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = a.length; aa < len1; aa++) {
              x = a[aa];
              results.push($.toString(x));
            }
            return results;
          })()).join(', ')) + "]";
        }),
        repr: safer(function(a) {
          var x;
          return "[" + (((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = a.length; aa < len1; aa++) {
              x = a[aa];
              results.push($.toRepr(x));
            }
            return results;
          })()).join(', ')) + "]";
        })
      },
      object: {
        string: safer(function(o) {
          var err, error1, k, ret, v;
          ret = [];
          for (k in o) {
            try {
              v = o[k];
            } catch (error1) {
              err = error1;
              v = "[Error: " + err.message + "]";
            }
            ret.push(k + ":" + ($.toString(v)));
          }
          return "{" + ret.join(', ') + "}";
        }),
        repr: safer(function(o) {
          var err, error1, k, ret, v;
          ret = [];
          for (k in o) {
            try {
              v = o[k];
            } catch (error1) {
              err = error1;
              v = "[Error: " + err.message + "]";
            }
            ret.push("\"" + k + "\": " + ($.toRepr(v)));
          }
          return "{" + ret.join(', ') + "}";
        })
      },
      "function": {
        repr: function(f) {
          return f.toString();
        },
        string: function(f) {
          return f.toString().replace(/^([^{]*){(?:.|\n|\r)*}$/, '$1{ ... }');
        }
      },
      number: {
        repr: function(n) {
          return String(n);
        },
        string: safer(function(n) {
          switch (false) {
            case n.precision == null:
              return n.toPrecision(n.precision);
            case n.fixed == null:
              return n.toFixed(n.fixed);
            default:
              return String(n);
          }
        })
      }
    });
    return {
      $: {
        toString: function(x) {
          var err, error1;
          if (arguments.length === 0) {
            return "function Bling() { [ ... ] }";
          } else {
            try {
              return $.type.lookup(x).string(x);
            } catch (error1) {
              err = error1;
              return "[$.toString Error: " + err.message + "]";
            }
          }
        },
        toRepr: function(x) {
          return $.type.lookup(x).repr(x);
        },
        px: function(x, delta) {
          if (delta == null) {
            delta = 0;
          }
          return (x != null) && (parseInt(x, 10) + (parseInt(delta) | 0)) + "px";
        },
        capitalize: function(name) {
          return (name.split(" ").map(function(x) {
            return x[0].toUpperCase() + x.substring(1).toLowerCase();
          })).join(" ");
        },
        slugize: slugize = function(phrase, slug) {
          var k, v;
          if (slug == null) {
            slug = "-";
          }
          phrase = (function() {
            switch ($.type(phrase)) {
              case 'null':
              case 'undefined':
                return "";
              case 'object':
                return ((function() {
                  var results;
                  results = [];
                  for (k in phrase) {
                    v = phrase[k];
                    results.push($.slugize(k, slug) + slug + $.slugize(v, slug));
                  }
                  return results;
                })()).join(slug);
              case 'array':
              case 'bling':
                return phrase.map(function(item) {
                  return $.slugize(item, slug);
                }).join(slug);
              default:
                return String(phrase);
            }
          })();
          return phrase.toLowerCase().replace(/^\s+/, '').replace(/\s+$/, '').replace(/\t/g, ' ').replace(/[^A-Za-z0-9. -]/g, '').replace(/\s+/g, '-');
        },
        stubize: slugize,
        dashize: function(name) {
          var aa, c, i, ref, ret;
          ret = "";
          for (i = aa = 0, ref = (name != null ? name.length : void 0) | 0; 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
            c = name.charCodeAt(i);
            if ((91 > c && c > 64)) {
              c += 32;
              ret += '-';
            }
            ret += String.fromCharCode(c);
          }
          return ret;
        },
        camelize: function(name) {
          var i;
          name = $.slugize(name);
          name.split('-');
          while ((i = name != null ? name.indexOf('-') : void 0) > -1) {
            name = $.stringSplice(name, i, i + 2, name[i + 1].toUpperCase());
          }
          return name;
        },
        commaize: function(num, comma, dot, currency) {
          var a, b, ref, s, sign;
          if (comma == null) {
            comma = ',';
          }
          if (dot == null) {
            dot = '.';
          }
          if (currency == null) {
            currency = '';
          }
          if ($.is('number', num) && isFinite(num)) {
            s = String(num);
            sign = num < 0 ? "-" : "";
            ref = s.split('.'), a = ref[0], b = ref[1];
            if (a.length > 3) {
              a = $.stringReverse($.stringReverse(a).match(/\d{1,3}/g).join(comma));
            }
            return sign + currency + a + (b != null ? dot + b : "");
          } else if ((typeof num === 'number' && isNaN(num)) || (num === Infinity || num === (-Infinity))) {
            return String(num);
          } else {
            return void 0;
          }
        },
        padLeft: function(s, n, c) {
          var dn;
          if (c == null) {
            c = " ";
          }
          dn = n - strip_ansi_codes(s).length;
          if (dn > 0) {
            return $.zeros(dn, c).join('') + s;
          } else {
            return s;
          }
        },
        padRight: function(s, n, c) {
          var dn;
          if (c == null) {
            c = " ";
          }
          dn = n - strip_ansi_codes(s).length;
          if (dn > 0) {
            return s + $.zeros(dn, c).join('');
          } else {
            return s;
          }
        },
        stringTruncate: function(s, n, c, sep) {
          var r, x;
          if (c == null) {
            c = '...';
          }
          if (sep == null) {
            sep = ' ';
          }
          if (s.length <= n) {
            return s;
          }
          if (c.length >= n) {
            return c;
          }
          s = s.split(sep);
          r = [];
          while (n > 0) {
            x = s.shift();
            n -= x.length;
            if (n >= 0) {
              r.push(x);
            }
          }
          return r.join(sep) + c;
        },
        stringCount: function(s, x, i, n) {
          var j;
          if (i == null) {
            i = 0;
          }
          if (n == null) {
            n = 0;
          }
          if ((j = s.indexOf(x, i)) > i - 1) {
            return $.stringCount(s, x, j + 1, n + 1);
          } else {
            return n;
          }
        },
        stringSplice: function(s, i, j, n) {
          var end, nn, start;
          nn = s.length;
          end = j;
          if (end < 0) {
            end += nn;
          }
          start = i;
          if (start < 0) {
            start += nn;
          }
          return s.substring(0, start) + n + s.substring(end);
        },
        stringReverse: function(s) {
          return s.split('').reverse().join('');
        },
        checksum: function(s) {
          var a, aa, b, i, ref;
          a = 1;
          b = 0;
          for (i = aa = 0, ref = s.length; 0 <= ref ? aa < ref : aa > ref; i = 0 <= ref ? ++aa : --aa) {
            a = (a + s.charCodeAt(i)) % 65521;
            b = (b + a) % 65521;
          }
          return (b << 16) | a;
        },
        repeat: function(x, n) {
          if (n == null) {
            n = 2;
          }
          switch (false) {
            case n !== 1:
              return x;
            case !(n < 1):
              return "";
            case !$.is("string", x):
              return $.zeros(n, x).join('');
            default:
              return $.zeros(n, x);
          }
        },
        stringBuilder: (function() {
          var len;
          len = function(s) {
            return (s != null ? s.toString().length : void 0) | 0;
          };
          return function() {
            var items;
            if ($.is("global", this)) {
              return new $.stringBuilder();
            }
            items = [];
            return $.extend(this, {
              length: 0,
              append: (function(_this) {
                return function(s) {
                  items.push(s);
                  return _this.length += len(s);
                };
              })(this),
              prepend: (function(_this) {
                return function(s) {
                  items.splice(0, 0, s);
                  return _this.length += len(s);
                };
              })(this),
              clear: (function(_this) {
                return function() {
                  var ret;
                  ret = _this.toString();
                  items = [];
                  _this.length = 0;
                  return ret;
                };
              })(this),
              toString: function() {
                return items.join("");
              }
            });
          };
        })()
      },
      toString: function() {
        return $.toString(this);
      },
      toRepr: function() {
        return $.toRepr(this);
      },
      replace: function(patt, repl) {
        return this.map(function(s) {
          return s.replace(patt, repl);
        });
      },
      indexOf: function(target, offset) {
        var aa, i, ref, ref1;
        if (offset == null) {
          offset = 0;
        }
        if ($.is('regexp', target)) {
          for (i = aa = ref = offset, ref1 = this.length; aa < ref1; i = aa += 1) {
            if (target.test(this[i])) {
              return i;
            }
          }
          return -1;
        } else {
          return Array.prototype.indexOf.apply(this, arguments);
        }
      }
    };
  });

  $.plugin({
    provides: "symbol",
    depends: "type"
  }, function() {
    var cache, g, symbol;
    symbol = null;
    cache = {};
    g = $.global;
    g['Bling'] = $;
    if (typeof module !== "undefined" && module !== null) {
      module.exports = $;
    }
    $.defineProperty($, "symbol", {
      set: function(v) {
        g[symbol] = cache[symbol];
        cache[symbol = v] = g[v];
        return g[v] = Bling;
      },
      get: function() {
        return symbol;
      }
    });
    return {
      $: {
        symbol: "$",
        noConflict: function() {
          $.symbol = "Bling";
          return Bling;
        }
      }
    };
  });

  $.plugin({
    provides: "synth",
    depends: "StateMachine, type, dom"
  }, function() {
    var SynthMachine, machine;
    SynthMachine = (function(superClass) {
      var common;

      extend1(SynthMachine, superClass);

      common = {
        "#": function() {
          return 2;
        },
        ".": SynthMachine.goto(3, true),
        "[": function() {
          return 4;
        },
        '"': function() {
          return 6;
        },
        "'": function() {
          return 7;
        },
        " ": function() {
          return 8;
        },
        "\t": function() {
          return 8;
        },
        "\n": function() {
          return 8;
        },
        "\r": function() {
          return 8;
        },
        ",": function() {
          return 10;
        },
        "+": function() {
          return 11;
        },
        eof: function() {
          return 13;
        }
      };

      SynthMachine.STATE_TABLE = [
        {
          enter: function() {
            this.tag = this.id = this.cls = this.attr = this.val = this.text = "";
            this.attrs = {};
            return 1;
          }
        }, $.extend({
          def: function(c) {
            this.tag += c;
            return 1;
          }
        }, common), $.extend({
          def: function(c) {
            this.id += c;
            return 2;
          }
        }, common), $.extend({
          enter: function() {
            if (this.cls.length > 0) {
              this.cls += " ";
            }
            return 3;
          },
          def: function(c) {
            this.cls += c;
            return 3;
          }
        }, common), {
          "=": function() {
            return 5;
          },
          "]": function() {
            this.attrs[this.attr] = this.val;
            this.attr = this.val = "";
            return 1;
          },
          def: function(c) {
            this.attr += c;
            return 4;
          },
          eof: function() {
            return 12;
          }
        }, {
          "]": function() {
            this.attrs[this.attr] = this.val;
            this.attr = this.val = "";
            return 1;
          },
          def: function(c) {
            this.val += c;
            return 5;
          },
          eof: function() {
            return 12;
          }
        }, {
          '"': function() {
            return 8;
          },
          def: function(c) {
            this.text += c;
            return 6;
          },
          eof: function() {
            return 12;
          }
        }, {
          "'": function() {
            return 8;
          },
          def: function(c) {
            this.text += c;
            return 7;
          },
          eof: function() {
            return 12;
          }
        }, {
          enter: function() {
            this.emitNode();
            this.emitText();
            return 0;
          }
        }, {}, {
          enter: function() {
            this.emitNode();
            this.cursor = null;
            return 0;
          }
        }, {
          enter: function() {
            var ref;
            this.emitNode();
            this.cursor = (ref = this.cursor) != null ? ref.parentNode : void 0;
            return 0;
          }
        }, {
          enter: function() {
            throw new Error("Error in synth expression: " + this.input);
          }
        }, {
          enter: function() {
            this.emitNode();
            this.emitText();
            return 0;
          }
        }
      ];

      function SynthMachine() {
        SynthMachine.__super__.constructor.call(this, SynthMachine.STATE_TABLE);
        this.reset();
      }

      SynthMachine.prototype.reset = function() {
        this.fragment = this.cursor = document.createDocumentFragment();
        this.tag = this.id = this.cls = this.attr = this.val = this.text = "";
        return this.attrs = {};
      };

      SynthMachine.prototype.emitNode = function() {
        var k, node;
        if (this.tag) {
          node = document.createElement(this.tag);
          if (this.id) {
            node.id = this.id;
          }
          if (this.cls) {
            node.className = this.cls;
          }
          for (k in this.attrs) {
            node.setAttribute(k, this.attrs[k]);
          }
          this.cursor.appendChild(node);
          return this.cursor = node;
        }
      };

      SynthMachine.prototype.emitText = function() {
        var ref;
        if (((ref = this.text) != null ? ref.length : void 0) > 0) {
          this.cursor.appendChild($.type.lookup("<html>").node(this.text));
          return this.text = "";
        }
      };

      return SynthMachine;

    })($.StateMachine);
    machine = new SynthMachine();
    return {
      $: {
        synth: function(expr) {
          machine.reset();
          machine.run(expr);
          if (machine.fragment.childNodes.length === 1) {
            return $(machine.fragment.childNodes[0]);
          } else {
            return $(machine.fragment);
          }
        }
      }
    };
  });

  $.plugin({
    depends: "StateMachine, function",
    provides: "template"
  }, function() {
    var current_engine, engines, match_forward, template;
    current_engine = null;
    engines = {};
    template = {
      register_engine: function(name, render_func) {
        engines[name] = render_func;
        if (current_engine == null) {
          return current_engine = name;
        }
      },
      render: function(text, args) {
        if (current_engine in engines) {
          return engines[current_engine](text, args);
        }
      }
    };
    template.__defineSetter__('engine', function(v) {
      if (!v in engines) {
        throw new Error("invalid template engine: " + v + " not one of " + (Object.Keys(engines)));
      } else {
        return current_engine = v;
      }
    });
    template.__defineGetter__('engine', function() {
      return current_engine;
    });
    template.__defineGetter__('engines', function() {
      return $.keysOf(engines);
    });
    template.register_engine('null', (function() {
      return $.identity;
    })());
    match_forward = function(text, find, against, start, stop) {
      var aa, count, i, ref, ref1, t;
      if (stop == null) {
        stop = -1;
      }
      count = 1;
      if (stop < 0) {
        stop = text.length + 1 + stop;
      }
      for (i = aa = ref = start, ref1 = stop; aa < ref1; i = aa += 1) {
        t = text[i];
        if (t === against) {
          count += 1;
        } else if (t === find) {
          count -= 1;
        }
        if (count === 0) {
          return i;
        }
      }
      return -1;
    };
    template.register_engine('pythonic', (function() {
      var chunk_re, compile, render, type_re;
      type_re = /([0-9#0+-]*)\.*([0-9#+-]*)([diouxXeEfFgGcrsqm])((?:.|\n)*)/;
      chunk_re = /%[\(\/]/;
      compile = function(text) {
        var aa, chunks, end, i, j, key, match, n, ref, rest, ret;
        chunks = text.split(chunk_re);
        n = chunks.length;
        ret = [chunks[0]];
        j = 1;
        for (i = aa = 1, ref = n; aa < ref; i = aa += 1) {
          end = match_forward(chunks[i], ')', '(', 0, -1);
          if (end === -1) {
            return "Template syntax error: unmatched '%(' starting at: " + (chunks[i].substring(0, 15));
          }
          key = chunks[i].substring(0, end);
          rest = chunks[i].substring(end);
          match = type_re.exec(rest);
          if (match === null) {
            return "Template syntax error: invalid type specifier starting at '" + rest + "'";
          }
          rest = match[4];
          ret[j++] = key;
          ret[j++] = match[1] | 0;
          ret[j++] = match[2] | 0;
          ret[j++] = match[3];
          ret[j++] = rest;
        }
        return ret;
      };
      compile.cache = {};
      return render = function(text, values) {
        var aa, cache, fixed, i, j, key, n, output, pad, ref, ref1, rest, type, value;
        cache = compile.cache[text];
        if (cache == null) {
          cache = compile.cache[text] = compile(text);
        }
        output = [cache[0]];
        j = 1;
        n = cache.length;
        for (i = aa = 1, ref = n - 5; aa <= ref; i = aa += 5) {
          ref1 = cache.slice(i, +(i + 4) + 1 || 9e9), key = ref1[0], pad = ref1[1], fixed = ref1[2], type = ref1[3], rest = ref1[4];
          value = values[key];
          if (value == null) {
            value = "missing value: " + key;
          }
          output[j++] = (function() {
            switch (type) {
              case 'd':
                return "" + parseInt(value, 10);
              case 'f':
                return parseFloat(value).toFixed(fixed);
              case 's':
                return "" + value;
              default:
                return "" + value;
            }
          })();
          if (pad > 0) {
            output[j] = $.padLeft(output[j], pad);
          }
          output[j++] = rest;
        }
        return output.join("");
      };
    })());
    return {
      $: {
        template: template
      }
    };
  });

  $.plugin({
    provides: "throttle",
    depends: "core"
  }, function() {
    var defer, throttle;
    defer = function(f, ctx, args, ms, to) {
      clearTimeout(to);
      to = setTimeout(((function(_this) {
        return function() {
          return f.apply(ctx, args);
        };
      })(this)), ms);
      return to;
    };
    throttle = function(f, ctx, args, ms, last) {
      var dt;
      if ((dt = $.now - last) > ms) {
        last += dt;
        f.apply(ctx, args);
      }
      return last;
    };
    return {
      $: {
        throttle: function(ms, f) {
          var last;
          last = 0;
          return function() {
            last = throttle(f, this, arguments, ms, last);
            return null;
          };
        },
        debounce: function(ms, f) {
          var timeout;
          timeout = null;
          return function() {
            var a;
            a = arguments;
            timeout = defer(f, this, arguments, ms, timeout);
            return null;
          };
        },
        rate_limit: function(ms, f) {
          "rate_limit is a combination of throttle and debounce.\n what we want from a stream throttle is to fire at most every _ms_ and\n then fire one last time after a gap of _ms_ at the end.";
          var last, timeout;
          last = 0;
          timeout = null;
          return function() {
            var a;
            a = arguments;
            timeout = defer(f, this, arguments, ms, timeout);
            last = throttle(f, this, arguments, ms, last);
            return null;
          };
        }
      }
    };
  });

  $.plugin({
    provides: 'TNET',
    depends: "type, string, function"
  }, function() {
    var Types, class_index, classes, makeFunction, packOne, register, reverseLookup, unpackOne;
    Types = {
      "number": {
        symbol: "#",
        pack: String,
        unpack: Number
      },
      "string": {
        symbol: "'",
        pack: $.identity,
        unpack: $.identity
      },
      "bool": {
        symbol: "!",
        pack: function(b) {
          return String(!!b);
        },
        unpack: function(s) {
          return s === "true";
        }
      },
      "null": {
        symbol: "~",
        pack: function() {
          return "";
        },
        unpack: function() {
          return null;
        }
      },
      "undefined": {
        symbol: "_",
        pack: function() {
          return "";
        },
        unpack: function() {
          return void 0;
        }
      },
      "array": {
        symbol: "]",
        pack: function(a) {
          var y;
          return ((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = a.length; aa < len1; aa++) {
              y = a[aa];
              results.push(packOne(y));
            }
            return results;
          })()).join('');
        },
        unpack: function(s) {
          var data, one, ref;
          data = [];
          while (s.length > 0) {
            ref = unpackOne(s), one = ref[0], s = ref[1];
            data.push(one);
          }
          return data;
        }
      },
      "bling": {
        symbol: "$",
        pack: function(a) {
          var y;
          return ((function() {
            var aa, len1, results;
            results = [];
            for (aa = 0, len1 = a.length; aa < len1; aa++) {
              y = a[aa];
              results.push(packOne(y));
            }
            return results;
          })()).join('');
        },
        unpack: function(s) {
          var data, one, ref;
          data = $();
          while (s.length > 0) {
            ref = unpackOne(s), one = ref[0], s = ref[1];
            data.push(one);
          }
          return data;
        }
      },
      "object": {
        symbol: "}",
        pack: function(o) {
          var k, v;
          return ((function() {
            var results;
            results = [];
            for (k in o) {
              v = o[k];
              if (k !== "constructor" && o.hasOwnProperty(k)) {
                results.push(packOne(k) + packOne(v));
              }
            }
            return results;
          })()).join('');
        },
        unpack: function(s) {
          var data, key, ref, ref1, value;
          data = {};
          while (s.length > 0) {
            ref = unpackOne(s), key = ref[0], s = ref[1];
            ref1 = unpackOne(s), value = ref1[0], s = ref1[1];
            data[key] = value;
          }
          return data;
        }
      },
      "function": {
        symbol: ")",
        pack: function(f) {
          var args, body, name, name_re, parts, s;
          s = f.toString().replace(/(?:\n|\r)+\s*/g, ' ');
          name = "";
          name_re = /function\s*(\w+)\(.*/g;
          if (name_re.test(s)) {
            name = s.replace(name_re, "$1");
          }
          parts = s.replace(/function\s*\w*\(/, '').replace(/\/\*.*\*\//g, '').replace(/}$/, '').split(/\) {/);
          args = parts[0].split(/, */);
          body = parts.slice(1).join(') {').replace(/^\s+/, '').replace(/\s*$/, '');
          return $(name, args, body).map(packOne).join('');
        },
        unpack: function(s) {
          var args, body, name, ref, ref1, ref2, rest;
          ref = unpackOne(s), name = ref[0], rest = ref[1];
          ref1 = unpackOne(rest), args = ref1[0], rest = ref1[1];
          ref2 = unpackOne(rest), body = ref2[0], rest = ref2[1];
          return makeFunction(name, args.join(), body);
        }
      },
      "regexp": {
        symbol: "/",
        pack: function(r) {
          return String(r).slice(1, -1);
        },
        unpack: function(s) {
          return RegExp(s);
        }
      },
      "class instance": {
        symbol: "C",
        pack: function(o) {
          if (!('constructor' in o)) {
            throw new Error("TNET: cant pack non-class as class");
          }
          if (!(o.constructor in class_index)) {
            throw new Error("TNET: cant pack unregistered class (name: " + o.constructor.name);
          }
          return packOne(class_index[o.constructor]) + packOne(o, "object");
        },
        unpack: function(s) {
          var i, obj, ref, ref1, rest;
          ref = unpackOne(s), i = ref[0], rest = ref[1];
          ref1 = unpackOne(rest), obj = ref1[0], rest = ref1[1];
          if (i <= classes.length) {
            obj.__proto__ = classes[i - 1].prototype;
          } else {
            throw new Error("TNET: attempt to unpack unregistered class index: " + i);
          }
          return obj;
        }
      }
    };
    makeFunction = function(name, args, body) {
      eval("var f = function " + name + "(" + args + "){" + body + "}");
      return f;
    };
    classes = [];
    class_index = {};
    register = function(klass) {
      return class_index[klass] || (class_index[klass] = classes.push(klass));
    };
    reverseLookup = {};
    (function() {
      var results, t, v;
      results = [];
      for (t in Types) {
        v = Types[t];
        results.push(reverseLookup[v.symbol] = v);
      }
      return results;
    })();
    unpackOne = function(data) {
      var di, i, ref, sym, x;
      if (data) {
        if ((i = data.indexOf(":")) > 0) {
          di = parseInt(data.slice(0, i), 10);
          if (isFinite(di) && $.is('number', di)) {
            if ((i < (ref = (x = i + 1 + di)) && ref < data.length)) {
              if (sym = reverseLookup[data[x]]) {
                return [sym.unpack(data.slice(i + 1, x)), data.slice(x + 1)];
              }
            }
          }
        }
      }
      return [void 0, data];
    };
    packOne = function(x, forceType) {
      var data, ref, ref1, ref2, t, tx;
      if (forceType != null) {
        tx = forceType;
      } else {
        tx = $.type(x);
        if (tx === "unknown" && !((ref = (ref1 = x.constructor) != null ? ref1.name : void 0) === (void 0) || ref === "Object")) {
          tx = "class instance";
        }
      }
      if ((t = Types[tx]) == null) {
        throw new Error("TNET: I don't know how to pack type '" + tx + "' (" + ((ref2 = x.constructor) != null ? ref2.name : void 0) + ")");
      }
      data = t.pack(x);
      return data.length + ":" + data + t.symbol;
    };
    return {
      $: {
        TNET: {
          Types: Types,
          registerClass: register,
          stringify: packOne,
          parse: function(x) {
            var ref;
            return (ref = Bling.TNET.parseOne(x)) != null ? ref[0] : void 0;
          },
          parseOne: function(x) {
            if (Buffer.isBuffer(x)) {
              x = x.toString();
            }
            return unpackOne(x);
          }
        }
      }
    };
  });

  $.plugin({
    provides: "trace",
    depends: "function,type,logger"
  }, function() {
    var time;
    $.type.extend({
      unknown: {
        trace: $.identity
      },
      object: {
        trace: function(label, o, tracer) {
          var aa, k, len1, ref;
          ref = Object.keys(o);
          for (aa = 0, len1 = ref.length; aa < len1; aa++) {
            k = ref[aa];
            o[k] = $.trace(o[k], label + "." + k, tracer);
          }
          return o;
        }
      },
      array: {
        trace: function(label, o, tracer) {
          var aa, i, ref;
          for (i = aa = 0, ref = o.length; aa < ref; i = aa += 1) {
            o[i] = $.trace(o[i], label + "[" + i + "]", tracer);
          }
          return o;
        }
      },
      bling: {
        trace: function(label, o, tracer) {
          var aa, i, ref;
          for (i = aa = 0, ref = o.length; aa < ref; i = aa += 1) {
            o[i] = $.trace(o[i], label + "[" + i + "]", tracer);
          }
          return o;
        }
      },
      "function": {
        trace: function(label, f, tracer) {
          var r;
          label || (label = f.name);
          r = function() {
            var a, args, elapsed, start;
            a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
            start = +(new Date);
            f.apply(this, a);
            label = (this.name || $.type(this)) + "." + label;
            args = $(a).map($.toRepr).join(',');
            elapsed = (+(new Date) - start).toFixed(0);
            return tracer(label + "(" + args + "): " + elapsed + "ms");
          };
          r.toString = function() {
            return "{Trace '" + label + "' of " + (f.toString());
          };
          return r;
        }
      }
    });
    time = function(label, f, logger) {
      var ref, ret, start;
      if (!$.is("string", label)) {
        ref = [label, f, "trace"], f = ref[0], logger = ref[1], label = ref[2];
      }
      if (!$.is("function", logger)) {
        logger = $.log;
      }
      start = +(new Date);
      ret = f();
      logger("[" + label + "] " + ((+(new Date) - start).toFixed(0)) + "ms");
      return ret;
    };
    return {
      $: {
        time: time,
        trace: function(label, o, tracer) {
          var ref;
          if (!$.is("string", label)) {
            ref = [o, label], tracer = ref[0], o = ref[1];
          }
          tracer || (tracer = $.log);
          label || (label = "");
          return $.type.lookup(o).trace(label, o, tracer);
        }
      }
    };
  });

  $.plugin({
    depends: "dom"
  }, function() {
    var COMMASEP, accel_props_re, speeds, testStyle, transformProperty, transitionDuration, transitionProperty, transitionTiming, updateDelay;
    COMMASEP = ", ";
    speeds = {
      "slow": 700,
      "medium": 500,
      "normal": 300,
      "fast": 100,
      "instant": 0,
      "now": 0
    };
    accel_props_re = /(?:scale(?:3d)*|translate(?:[XYZ]|3d)*|rotate(?:[XYZ]|3d)*)/;
    updateDelay = 30;
    testStyle = document.createElement("div").style;
    transformProperty = "transform";
    transitionProperty = "transition-property";
    transitionDuration = "transition-duration";
    transitionTiming = "transition-timing-function";
    if ("WebkitTransform" in testStyle) {
      transformProperty = "-webkit-transform";
      transitionProperty = "-webkit-transition-property";
      transitionDuration = "-webkit-transition-duration";
      transitionTiming = "-webkit-transition-timing-function";
    } else if ("MozTransform" in testStyle) {
      transformProperty = "-moz-transform";
      transitionProperty = "-moz-transition-property";
      transitionDuration = "-moz-transition-duration";
      transitionTiming = "-moz-transition-timing-function";
    } else if ("OTransform" in testStyle) {
      transformProperty = "-o-transform";
      transitionProperty = "-o-transition-property";
      transitionDuration = "-o-transition-duration";
      transitionTiming = "-o-transition-timing-function";
    }
    return {
      $: {
        duration: function(speed) {
          var d;
          d = speeds[speed];
          if (d != null) {
            return d;
          }
          return parseFloat(speed);
        }
      },
      transform: function(end_css, speed, easing, callback) {
        var css, duration, i, ii, props, trans;
        if ($.is("function", speed)) {
          callback = speed;
          speed = easing = null;
        } else if ($.is("function", easing)) {
          callback = easing;
          easing = null;
        }
        if (speed == null) {
          speed = "normal";
        }
        easing || (easing = "ease");
        duration = $.duration(speed) + "ms";
        props = [];
        trans = "";
        css = {};
        for (i in end_css) {
          if (accel_props_re.test(i)) {
            ii = end_css[i];
            if (ii.join) {
              ii = $(ii).px().join(COMMASEP);
            } else if (ii.toString) {
              ii = ii.toString();
            }
            trans += " " + i + "(" + ii + ")";
          } else {
            css[i] = end_css[i];
          }
        }
        for (i in css) {
          props.push(i);
        }
        if (trans) {
          props.push(transformProperty);
        }
        css[transitionProperty] = props.join(COMMASEP);
        css[transitionDuration] = props.map(function() {
          return duration;
        }).join(COMMASEP);
        css[transitionTiming] = props.map(function() {
          return easing;
        }).join(COMMASEP);
        if (trans) {
          css[transformProperty] = trans;
        }
        this.css(css);
        if (callback) {
          return this.delay(duration, $.bound(this, callback));
        }
      },
      hide: function(callback) {
        this.each(function() {
          if (this.style) {
            this._display = "";
            if (this.style.display === !"none") {
              this._display = this.syle.display;
            }
            return this.style.display = "none";
          }
        }).trigger("hide");
        if (callback) {
          this.delay(updateDelay, $.bound(this, callback));
        }
        return this;
      },
      show: function(callback) {
        this.each(function() {
          if (this.style) {
            this.style.display = this._display;
            return delete this._display;
          }
        }).trigger("show");
        if (callback) {
          this.delay(updateDelay, $.bound(this, callback));
        }
        return this;
      },
      toggle: function(callback) {
        return this.weave(this.css("display")).fold(function(display, node) {
          if (display === "none") {
            node.style.display = node._display || "";
            delete node._display;
            $(node).trigger("show");
          } else {
            node._display = display;
            node.style.display = "none";
            $(node).trigger("hide");
          }
          return node;
        }).delay(updateDelay, $.bound(this, callback));
      },
      fadeIn: function(speed, callback) {
        return this.css('opacity', '0.0').show(function() {
          return this.transform({
            opacity: "1.0",
            translate3d: [0, 0, 0]
          }, speed, callback);
        });
      },
      fadeOut: function(speed, callback, x, y) {
        if (x == null) {
          x = 0.0;
        }
        if (y == null) {
          y = 0.0;
        }
        return this.transform({
          opacity: "0.0",
          translate3d: [x, y, 0.0]
        }, speed, function() {
          return this.hide($.bound(this, callback));
        });
      },
      fadeLeft: function(speed, callback) {
        return this.fadeOut(speed, callback, "-" + this.width().first(), 0.0);
      },
      fadeRight: function(speed, callback) {
        return this.fadeOut(speed, callback, this.width().first(), 0.0);
      },
      fadeUp: function(speed, callback) {
        return this.fadeOut(speed, callback, 0.0, "-" + this.height().first());
      },
      fadeDown: function(speed, callback) {
        return this.fadeOut(speed, callback, 0.0, this.height().first());
      }
    };
  });

  $.plugin({
    provides: "type,is,inherit,extend,defineProperty,isType,are,as,isSimple,isDefined,isEmpty",
    depends: "compat"
  }, function() {
    var __toString, _type, inherit, isType, maxHash;
    __toString = Object.prototype.toString;
    isType = function(T, o) {
      if (o == null) {
        return T === o || T === "null" || T === "undefined";
      } else {
        return ((o.constructor != null) && (o.constructor === T || o.constructor.name === T)) || __toString.apply(o) === ("[object " + T + "]") || isType(T, o.__proto__);
      }
    };
    inherit = function() {
      var obj, objs, parent, ref;
      parent = arguments[0], objs = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      if (!(objs.length > 0)) {
        return;
      }
      obj = objs.shift();
      if (typeof parent === "function") {
        parent = parent.prototype;
      }
      if ((ref = parent.__proto__) === Object.prototype || ref === null || ref === (void 0)) {
        parent.__proto__ = obj.__proto__;
      }
      obj.__proto__ = parent;
      if (objs.length > 0) {
        return inherit.apply(null, [obj].concat(slice.call(objs)));
      } else {
        return obj;
      }
    };
    _type = (function() {
      var _extend, _with_cache, _with_insert, base, cache, lookup, order, register;
      cache = {};
      base = {
        name: 'unknown',
        is: function() {
          return true;
        }
      };
      order = [];
      _with_cache = {};
      _with_insert = function(method, type) {
        var a, i;
        a = (_with_cache[method] || (_with_cache[method] = []));
        if ((i = a.indexOf(type)) === -1) {
          return a.push(type);
        }
      };
      register = function(name, data) {
        var key;
        data.is || (data.is = function() {
          return false;
        });
        if (name in cache) {
          return _extend(name, data);
        }
        if (!(name in cache)) {
          order.unshift(name);
        }
        cache[data.name = name] = base !== data ? inherit(base, data) : data;
        cache[name][name] = function(o) {
          return o;
        };
        for (key in cache[name]) {
          _with_insert(key, cache[name]);
        }
        return cache[name];
      };
      _extend = function(name, data) {
        var k, method;
        if (typeof name === "string") {
          cache[name] || (cache[name] = register(name, {}));
          cache[name] = extend(cache[name], data);
          for (method in data) {
            _with_insert(method, cache[name]);
          }
        } else if (typeof name === "object") {
          for (k in name) {
            _extend(k, name[k]);
          }
        }
        return null;
      };
      lookup = function(obj) {
        var aa, len1, name;
        for (aa = 0, len1 = order.length; aa < len1; aa++) {
          name = order[aa];
          if (cache[name].is.call(obj, obj)) {
            return cache[name];
          }
        }
        return null;
      };
      register("unknown", base);
      register("object", {
        is: function(o) {
          var ref, ref1;
          return (o != null) && (typeof o === "object") && ((ref = (ref1 = o.constructor) != null ? ref1.name : void 0) === (void 0) || ref === "Object");
        }
      });
      register("array", {
        is: Array.isArray || function(o) {
          return isType(Array, o);
        }
      });
      register("buffer", {
        is: $.global.Buffer.isBuffer || function() {
          return false;
        }
      });
      register("error", {
        is: function(o) {
          return isType('Error', o);
        }
      });
      register("regexp", {
        is: function(o) {
          return isType('RegExp', o);
        }
      });
      register("string", {
        is: function(o) {
          return typeof o === "string";
        }
      });
      register("number", {
        is: function(o) {
          return typeof o === "number" && !isNaN(o);
        }
      });
      register("bool", {
        is: function(o) {
          return typeof o === "boolean";
        }
      });
      register("function", {
        is: function(o) {
          return typeof o === "function";
        }
      });
      register("global", {
        is: function(o) {
          return typeof o === "object" && 'setInterval' in o;
        }
      });
      register("arguments", {
        is: function(o) {
          return typeof o === "object" && 'callee' in o && 'length' in o;
        }
      });
      register("undefined", {
        is: function(x) {
          return x === void 0;
        }
      });
      register("null", {
        is: function(x) {
          return x === null;
        }
      });
      return extend((function(o) {
        return lookup(o).name;
      }), {
        register: register,
        lookup: lookup,
        extend: _extend,
        get: function(t) {
          return cache[t];
        },
        is: function(t, o) {
          var ref, ref1;
          return (ref = (ref1 = cache[t]) != null ? ref1.is.call(o, o) : void 0) != null ? ref : false;
        },
        as: function() {
          var base1, o, rest, t;
          t = arguments[0], o = arguments[1], rest = 3 <= arguments.length ? slice.call(arguments, 2) : [];
          return typeof (base1 = lookup(o))[t] === "function" ? base1[t].apply(base1, [o].concat(slice.call(rest))) : void 0;
        },
        "with": function(f) {
          var ref;
          return (ref = _with_cache[f]) != null ? ref : [];
        }
      });
    })();
    _type.extend({
      unknown: {
        array: function(o) {
          return [o];
        }
      },
      "null": {
        array: function() {
          return [];
        }
      },
      undefined: {
        array: function() {
          return [];
        }
      },
      array: {
        array: function(o) {
          return o;
        }
      },
      number: {
        array: function(o) {
          return $.extend(new Array(o), {
            length: 0
          });
        }
      },
      "arguments": {
        array: function(o) {
          return Array.prototype.slice.apply(o);
        }
      }
    });
    maxHash = 0xFFFFFFFF;
    _type.register("bling", {
      is: function(o) {
        return o && isType($, o);
      },
      array: function(o) {
        return (o && o.toArray()) || [];
      },
      hash: function(o) {
        return o.map($.hash).reduce(function(a, x) {
          return ((a * a) + x) % maxHash;
        });
      },
      string: function(o) {
        return $.symbol + "([" + o.map(function(x) {
          return $.type.lookup(x).string(x);
        }).join(", ") + "])";
      },
      repr: function(o) {
        return $.symbol + "([" + o.map(function(x) {
          return $.type.lookup(x).repr(x);
        }).join(", ") + "])";
      }
    });
    _type["in"] = function() {
      var aa, ab, len1, obj, type, types;
      types = 2 <= arguments.length ? slice.call(arguments, 0, aa = arguments.length - 1) : (aa = 0, []), obj = arguments[aa++];
      for (ab = 0, len1 = types.length; ab < len1; ab++) {
        type = types[ab];
        if ($.is(type, obj)) {
          return true;
        }
      }
      return false;
    };
    return {
      $: {
        inherit: inherit,
        extend: extend,
        defineProperty: function(o, name, opts) {
          Object.defineProperty(o, name, extend({
            configurable: true,
            enumerable: true
          }, opts));
          return o;
        },
        isType: isType,
        type: _type,
        is: _type.is,
        are: function() {
          var a, aa, args, len1, type;
          type = arguments[0], args = 2 <= arguments.length ? slice.call(arguments, 1) : [];
          for (aa = 0, len1 = args.length; aa < len1; aa++) {
            a = args[aa];
            if (!$.is(type, a)) {
              return false;
            }
          }
          return true;
        },
        as: _type.as,
        isDefined: function(o) {
          return o != null;
        },
        isSimple: function(o) {
          return _type["in"]("string", "number", "bool", o);
        },
        isEmpty: function(o) {
          return (o === "" || o === null || o === (void 0)) || o.length === 0 || (typeof o === "object" && Object.keys(o).length === 0);
        }
      },
      defineProperty: function(name, opts) {
        return this.each(function() {
          return $.defineProperty(this, name, opts);
        });
      }
    };
  });

  $.plugin({
    depends: 'math',
    provides: 'units'
  }, function() {
    var UNIT_RE, conv, convert, fill, init, locker, makeUnitRegex, parseUnits, set, units;
    units = $(["px", "pt", "pc", "em", "%", "in", "cm", "mm", "ex", "lb", "kg", "yd", "ft", "m", ""]);
    UNIT_RE = null;
    (makeUnitRegex = function() {
      var joined;
      joined = units.filter(/.+/).join('|');
      return UNIT_RE = new RegExp("(\\d+\\.*\\d*)((?:" + joined + ")/*(?:" + joined + ")*)$");
    })();
    parseUnits = function(s) {
      if (UNIT_RE.test(s)) {
        return UNIT_RE.exec(s)[2];
      }
      return "";
    };
    conv = function(a, b) {
      var denom_a, denom_b, numer_a, numer_b, ref, ref1;
      ref = a.split('/'), numer_a = ref[0], denom_a = ref[1];
      ref1 = b.split('/'), numer_b = ref1[0], denom_b = ref1[1];
      if ((denom_a != null) && (denom_b != null)) {
        return conv(denom_b, denom_a) * conv(numer_a, numer_b);
      }
      if (a in conv && (b in conv[a])) {
        return conv[a][b]();
      }
      return 0;
    };
    locker = function(x) {
      return function() {
        return x;
      };
    };
    fill = function() {};
    set = function(from, to, f) {
      conv[from] || (conv[from] = {});
      conv[from][to] = f;
      if (units.indexOf(from) === -1) {
        units.push(from);
      }
      if (units.indexOf(to) === -1) {
        units.push(to);
      }
      makeUnitRegex();
      return fill();
    };
    init = function() {
      $.type.register("units", {
        is: function(x) {
          return typeof x === "string" && UNIT_RE.test(x);
        },
        number: function(x) {
          return parseFloat(x);
        },
        string: function(x) {
          return "'" + x + "'";
        }
      });
      set('pc', 'pt', function() {
        return 12;
      });
      set('in', 'pt', function() {
        return 72;
      });
      set('in', 'px', function() {
        return 96;
      });
      set('in', 'cm', function() {
        return 2.54;
      });
      set('m', 'ft', function() {
        return 3.281;
      });
      set('yd', 'ft', function() {
        return 3;
      });
      set('cm', 'mm', function() {
        return 10;
      });
      set('m', 'cm', function() {
        return 100;
      });
      set('m', 'meter', function() {
        return 1;
      });
      set('m', 'meters', function() {
        return 1;
      });
      set('ft', 'feet', function() {
        return 1;
      });
      set('km', 'm', function() {
        return 1000;
      });
      set('em', 'px', function() {
        var w, x;
        w = 0;
        try {
          x = $("<span style='font-size:1em;visibility:hidden'>x</span>").appendTo("body");
          w = x.width().first();
          x.remove();
        } catch (undefined) {}
        return w;
      });
      set('ex', 'px', function() {
        var w, x;
        w = 0;
        try {
          x = $("<span style='font-size:1ex;visibility:hidden'>x</span>").appendTo("body");
          w = x.width().first();
          x.remove();
        } catch (undefined) {}
        return w;
      });
      set('ex', 'em', function() {
        return 2;
      });
      set('rad', 'deg', function() {
        return 57.3;
      });
      set('s', 'sec', function() {
        return 1;
      });
      set('s', 'ms', function() {
        return 1000;
      });
      set('ms', 'ns', function() {
        return 1000000;
      });
      set('min', 'sec', function() {
        return 60;
      });
      set('hr', 'min', function() {
        return 60;
      });
      set('hr', 'hour', function() {
        return 1;
      });
      set('hr', 'hours', function() {
        return 1;
      });
      set('day', 'hr', function() {
        return 24;
      });
      set('day', 'days', function() {
        return 1;
      });
      set('y', 'year', function() {
        return 1;
      });
      set('y', 'years', function() {
        return 1;
      });
      set('y', 'd', function() {
        return 365.25;
      });
      set('g', 'gram', function() {
        return 1;
      });
      set('g', 'grams', function() {
        return 1;
      });
      set('kg', 'g', function() {
        return 1000;
      });
      set('lb', 'g', function() {
        return 453.6;
      });
      set('lb', 'oz', function() {
        return 16;
      });
      set('f', 'frame', function() {
        return 1;
      });
      set('f', 'frames', function() {
        return 1;
      });
      set('sec', 'f', function() {
        return 60;
      });
      (fill = function() {
        var a, aa, ab, ac, ad, b, c, infered, len1, len2, len3, len4, one;
        conv[''] = {};
        one = locker(1.0);
        for (aa = 0, len1 = units.length; aa < len1; aa++) {
          a = units[aa];
          conv[a] || (conv[a] = {});
          conv[a][a] = conv[a][''] = conv[''][a] = one;
        }
        infered = 1;
        while (infered > 0) {
          infered = 0;
          for (ab = 0, len2 = units.length; ab < len2; ab++) {
            a = units[ab];
            if (!(a !== '')) {
              continue;
            }
            conv[a] || (conv[a] = {});
            for (ac = 0, len3 = units.length; ac < len3; ac++) {
              b = units[ac];
              if (!(b !== '')) {
                continue;
              }
              if ((!conv(a, b)) && (conv(b, a))) {
                conv[a][b] = locker(1.0 / conv(b, a));
                infered += 1;
              }
              for (ad = 0, len4 = units.length; ad < len4; ad++) {
                c = units[ad];
                if (c !== '') {
                  if ((conv(a, b)) && (conv(b, c)) && (!conv(a, c))) {
                    conv[a][c] = locker(conv(a, b) * conv(b, c));
                    infered += 1;
                  }
                }
              }
            }
          }
        }
        return null;
      })();
      return $.units.enable = function() {};
    };
    convert = function(unit, number) {
      var c, f, u;
      f = parseFloat(number);
      u = parseUnits(number);
      c = conv(u, unit);
      if (!(isFinite(c) && isFinite(f))) {
        return number;
      }
      return "" + (f * c) + unit;
    };
    return {
      $: {
        units: {
          enable: init,
          set: set,
          get: conv,
          convertTo: convert
        }
      },
      convertTo: function(unit) {
        return this.map(function(x) {
          return convert(unit, x);
        });
      },
      unitMap: function(f) {
        return this.map(function(x) {
          var n;
          return f.call((n = parseFloat(x)), n) + parseUnits(x);
        });
      }
    };
  });

  $.plugin({
    depends: "type",
    provides: "url,URL"
  }, function() {
    var clean, host_port_re, parse, parse_host, stringify, url_re, user_pass_re, username_re;
    url_re = /\b(?:([a-z+]+):)(?:\/{1,2}([^?\/#]*?))(\/[^?]*)*(?:\?([^#]+))*(?:#([^\s]+))*$/i;
    user_pass_re = /^([^:]+):([^@]+)@/;
    username_re = /^([^:@]+)@/;
    host_port_re = /^([^:]+):(\d+)/;
    parse_host = function(host) {
      var m, ret;
      if (!((host != null) && host.length > 0)) {
        return {};
      }
      ret = {
        host: host
      };
      if (ret.host.indexOf(",") > -1) {
        $.extend(ret, {
          hosts: ret.host.split(",").map(parse_host),
          host: void 0
        });
      } else {
        if ((m = ret.host.match(user_pass_re))) {
          $.extend(ret, {
            username: m[1],
            password: m[2],
            host: ret.host.replace(user_pass_re, '')
          });
        } else if ((m = ret.host.match(username_re))) {
          $.extend(ret, {
            username: m[1],
            host: ret.host.replace(username_re, '')
          });
        }
        if ((m = ret.host.match(host_port_re))) {
          $.extend(ret, {
            host: m[1],
            port: m[2]
          });
        }
      }
      return ret;
    };
    parse = function(str, parseQuery) {
      var aa, i, len1, m, pair, query, ref, ref1, ref2, ref3, ret;
      if (parseQuery == null) {
        parseQuery = false;
      }
      ret = (m = str != null ? str.match(url_re) : void 0) ? {
        protocol: m[1],
        host: m[2],
        path: m[3],
        query: (ref = m[4]) != null ? ref.replace(/^\?/, '') : void 0,
        hash: (ref1 = m[5]) != null ? ref1.replace(/^#/, '') : void 0
      } : null;
      if (ret != null) {
        if (parseQuery) {
          query = (ref2 = ret.query) != null ? ref2 : "";
          ret.query = Object.create(null);
          ref3 = query.split('&');
          for (aa = 0, len1 = ref3.length; aa < len1; aa++) {
            pair = ref3[aa];
            if ((i = pair.indexOf('=')) > -1) {
              ret.query[pair.substring(0, i)] = unescape(pair.substring(i + 1));
            } else if (pair.length > 0) {
              ret.query[pair] = null;
            }
          }
          delete ret.query[""];
        }
        $.extend(ret, parse_host(ret.host));
        $.keysOf(ret).each(function(key) {
          switch ($.type(ret[key])) {
            case "null":
            case "undefined":
              delete ret[key];
              break;
            case "string":
              if (ret[key].length === 0) {
                delete ret[key];
              }
          }
          return null;
        });
      }
      return ret;
    };
    clean = function(val, re, prefix, suffix) {
      var x;
      if (prefix == null) {
        prefix = '';
      }
      if (suffix == null) {
        suffix = '';
      }
      x = val != null ? val : "";
      if (x && !re.test(x)) {
        return prefix + x + suffix;
      } else {
        return x;
      }
    };
    stringify = function(url) {
      var k, v;
      if ($.is('object', url.query)) {
        url.query = ((function() {
          var ref, results;
          ref = url.query;
          results = [];
          for (k in ref) {
            v = ref[k];
            results.push(k + "=" + v);
          }
          return results;
        })()).join("&");
      }
      return [clean(url.protocol, /:$/, '', ':'), clean(url.host, /^\//, '//'), clean(url.port, /^:/, ':'), clean(url.path, /^\//, '/'), clean(url.query, /^\?/, '?'), clean(url.hash, /^#/, '#')].join('');
    };
    return {
      $: {
        URL: {
          parse: parse,
          stringify: stringify
        }
      }
    };
  });

  $.plugin({
    provides: "watchProperty",
    depends: "type"
  }, function() {
    var OP_CHANGE, OP_DELETE, OP_INSERT, watchArray, watchProperty;
    OP_CHANGE = 'change';
    OP_INSERT = 'insert';
    OP_DELETE = 'delete';
    watchProperty = function(obj, key, cb, prefix) {
      var first, get, i, prop, ref;
      if (prefix == null) {
        prefix = "";
      }
      if (typeof key === 'string' && (i = key.indexOf(".")) > -1) {
        first = key.substr(0, i);
        return watchProperty(obj[first], key.substr(i + 1), cb, ((prefix != null ? prefix.length : void 0) && prefix + '.' + first) || first);
      }
      if ($.is('array', obj[key])) {
        watchArray(obj[key], cb, ((prefix != null ? prefix.length : void 0) && prefix + '.' + key) || key);
      }
      prop = Object.getOwnPropertyDescriptor(obj, key);
      return $.defineProperty(obj, key, {
        get: get = (ref = prop.get) != null ? ref : function() {
          return prop.value;
        },
        set: $.compose($.partial(cb, OP_CHANGE, ((prefix != null ? prefix.length : void 0) && prefix + '.' + key) || key), prop.set || (prop.writable && function(v) {
          return prop.value = v;
        }) || get)
      });
    };
    watchArray = function(arr, cb, prefix) {
      var _watch, pcb, rebindAll;
      if (prefix == null) {
        prefix = "";
      }
      pcb = function(op, key, value) {
        return cb(op, ((prefix != null ? prefix.length : void 0) && prefix + '.' + key) || key, value);
      };
      _watch = function(method, _cb) {
        var supr;
        supr = arr[method];
        return arr[method] = function() {
          var a;
          a = 1 <= arguments.length ? slice.call(arguments, 0) : [];
          try {
            return supr.apply(arr, a);
          } finally {
            _cb.apply(arr, a);
          }
        };
      };
      (rebindAll = function() {
        var aa, i, ref;
        for (i = aa = 0, ref = arr.length; aa < ref; i = aa += 1) {
          watchProperty(arr, i, pcb);
        }
        return null;
      })();
      _watch('push', function(item) {
        var i;
        i = this.length - 1;
        watchProperty(this, i, pcb);
        return pcb(OP_INSERT, i, item);
      });
      _watch('unshift', function(item) {
        rebindAll();
        return pcb(OP_INSERT, 0, item);
      });
      _watch('pop', function() {
        return pcb(OP_DELETE, this.length, 1);
      });
      _watch('shift', function() {
        rebindAll();
        return pcb(OP_DELETE, this.length, 1);
      });
      _watch('splice', function(i, n, v) {
        if (v !== void 0) {
          i += 1;
          n -= 1;
        } else if (n > 0) {
          i = this.length;
        }
        if (n > 0) {
          return pcb(OP_DELETE, i, n);
        }
      });
      return arr;
    };
    return {
      $: {
        watchProperty: watchProperty
      }
    };
  });

}).call(this);

//# sourceMappingURL=bling.js.map
